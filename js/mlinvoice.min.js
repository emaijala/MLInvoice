/*! mlinvoice 2021-09-18 */

var MLInvoice=function MLInvoice(){var _modules=[],_initDone=!1,_translations={},_dispatchNotePrintStyle="none",_offerStatuses=[],_keepAliveEnabled=!0,_currencyDecimals=2;function addTranslation(e,t){_translations[e]=t}function addTranslations(e){for(var t in e)"string"==typeof e[t]&&addTranslation(t,e[t])}function addModule(e,t){void 0===this[e]&&(_modules.push(e),this[e]="function"==typeof t?t():t,_initDone&&this[e].init&&this[e].init())}function translate(e,t,a){var n=_translations[e]||e;return n===e&&void 0!==a&&(n=a),"object"==typeof t&&$.each(t,function(e,t){n=n.replace(new RegExp(e,"g"),t)}),n}function setDispatchNotePrintStyle(e){_dispatchNotePrintStyle=e}function getDispatchNotePrintStyle(){return _dispatchNotePrintStyle}function setOfferStatuses(e){_offerStatuses=e}function isOfferStatus(e){return-1!==_offerStatuses.indexOf(e)}function parseDate(e,t){if(!e)return null;t=void 0===t?"":t;return e.substr(6,4)+t+e.substr(3,2)+t+e.substr(0,2)}function _parseFloat(e){return new String(e).replace(",",".")}function formatCurrency(e,t){var a=void 0===t?_currencyDecimals:t,t=translate("DecimalSeparator"),n=translate("ThousandSeparator",[],""),a=parseFloat(e).toFixed(a).replace(".",t);if(n){for(var i=a.split(t),o=new RegExp("(\\d+)(\\d{3})"+t+"?");o.test(i[0]);)i[0]=i[0].replace(o,"$1"+n+"$2");a=i[0],1<i.length&&(a+=t+i[1])}return a}function _keepAlive(){$.getJSON("json.php?func=noop").done(function(){window.setTimeout(_keepAlive,6e4)})}function setKeepAlive(e){_keepAliveEnabled=e}function setCurrencyDecimals(e){_currencyDecimals=e}function ajaxErrorHandler(e){return $("#spinner").addClass("hidden"),409==e.status?errormsg(jQuery.parseJSON(e.responseText).warnings):errormsg("Error trying to access the server: "+e.status+" - "+e.statusText),!1}function _setupSelectAll(){$(".cb-select-all").click(function(){var e=$(this).closest("table");e.find(".cb-select-row").prop("checked",$(this).prop("checked")),updateRowSelectedState(e.closest(".list_container"))})}function _setupCoverLetterForm(){$("#cover-letter-button").click(function(){$("#cover-letter-form").toggleClass("hidden")}),$("#cover-letter-form .close-btn").click(function(){$("#cover-letter-form").addClass("hidden")})}function _setupCustomPricesForm(){$("#add-custom-prices").click(function(){$("#no-custom-prices").addClass("hidden"),$("#custom-prices-form").removeClass("hidden")}),$("#custom-prices-form .save-button").click(function(){var e=$("#custom-prices-form"),e={company_id:$("#company_id").val(),discount:_parseFloat(e.find("#discount").val()),multiplier:_parseFloat(e.find("#multiplier").val()),valid_until:parseDate(e.find("#valid_until").val())};return $.ajax({url:"json.php?func=put_custom_prices",type:"POST",dataType:"json",data:JSON.stringify(e),contentTypes:"application/json; charset=utf-8",success:function(){infomsg(translate("RecordSaved"),2e3),window.location.reload()}}),!1}),$("#custom-prices-form .delete-button").click(function(){if(confirm(translate("ConfirmDelete"))){var e={company_id:$("#company_id").val()};return $.ajax({url:"json.php?func=delete_custom_prices",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(){infomsg(translate("RecordDeleted"),2e3),window.location.reload()}}),!1}})}function editUnitPrice(){return _editUnitPrice(this)}function _editUnitPrice(n){function i(){a.text(c),a.removeClass("editing")}function o(){var e=a.find("input");e.css("width",a.innerWidth()-36),a.append('<img src="images/spinner.gif" alt="">');var t=String(e.val());t!==c?(e={company_id:$("#company_id").val(),product_id:d[0],unit_price:_parseFloat(t)},$.ajax({url:"json.php?func="+(""===t?"delete_custom_price":"put_custom_price"),type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){a.removeClass("editing");e=null!==e.unit_price?formatCurrency(e.unit_price):s.fnGetData(a.prev().get(0));""===t?(a.text(e),r.removeClass("custom-price")):(a.text(e),r.addClass("custom-price"))},error:function(){a.text(t),a.removeClass("editing")}})):i()}var a=$(n),r=a.parents("tr"),s=a.parents("table").dataTable(),c=a.text(),d=s.fnGetData(r),e=$("<input/>").attr("type","text").attr("value",c).css("width",a.innerWidth()-12).keydown(function(e){if(13===e.which)$(this).data("handled",!0),o();else if(27===e.which)$(this).data("handled",!0),i();else if(9===e.which){var t=$("td.editable"),a=t.index(n);return e.shiftKey?0<a&&t[a-1].click():t.length>a+1&&t[a+1].click(),!1}}).click(function(){return!1}).blur(function(){$(this).data("handled")||o()});return a.empty().addClass("editing").append(e),e.select().focus(),!1}function updateRowSelectedState(e){e=void 0===e?$("body"):$(e);0===e.find(".cb-select-row:checked").length?(e.find(".selected-row-button").attr("disabled","disabled"),e.find(".selected-row-button").addClass("ui-state-disabled")):(e.find(".selected-row-button").removeAttr("disabled"),e.find(".selected-row-button").removeClass("ui-state-disabled"))}function infomsg(e,t){$.floatingMessage("<span>"+e+"</span>",{position:"top-right",className:"ui-widget ui-state-highlight",show:"show",hide:"fade",stuffEaseTime:200,moveEaseTime:0,time:void 0!==t?t:1e4})}function errormsg(e,t){$.floatingMessage("<span>"+e+"</span>",{position:"top-right",className:"ui-widget ui-state-error",show:"show",hide:"fade",stuffEaseTime:200,moveEaseTime:0,time:void 0!==t?t:1e4})}function clearMessages(){$(".ui-floating-message").trigger("destroy")}function checkForUpdates(t){$.cookie("updateversion")&&$.cookie("currentversion")===t?_updateVersionMessage($.parseJSON($.cookie("updateversion")),t):$.getJSON("json.php?func=get_update_info",function(e){_updateVersionMessage(e),$.cookie("currentversion",t)})}function _updateVersionMessage(e){var t;void 0!==e.version&&(t=String(e.date),t=translate("UpdateAvailableTitle",{"{version}":e.version,"{date}":t.substr(8,2)+"."+t.substr(5,2)+"."+t.substr(0,4)}),t=$("<span/>").attr("title",t).text(translate("UpdateAvailable")+" "),$("<br>").appendTo(t),$("<a>").attr("href",e.url).attr("target","_blank").text(translate("UpdateInformation")).appendTo(t),$("<br>").appendTo(t),$("<a>").attr("href","index.php?func=system&operation=update").text(translate("UpdateNow")).appendTo(t),t.appendTo("#version")),$.cookie("updateversion",JSON.stringify(e),{expires:1})}function calcRowSum(e){var t=e.partial_payment?1:e.pcs,a=e.price,n=e.discount||0,i=e.discount_amount||0,o=e.vat;a*=1-n/100,a-=i;var r=0,n=0,i=0;return 1===Number(e.vat_included)?i=(n=t*a)-(r=n/(1+o/100)):n=(r=t*a)+(i=r*(o/100)),{sum:r,VAT:i,sumVAT:n}}function popupDialog(url,on_close,dialog_title,event,width,height){var buttons={};return buttons[translate("Close")]=function(){$("#popup_dlg").dialog("close")},$("#popup_dlg").find("#popup_dlg_iframe").html(""),$("#popup_dlg").dialog({modal:!0,width:width,height:height,resizable:!0,buttons:buttons,title:dialog_title,close:function onPopupClose(){eval(on_close)}}).find("#popup_dlg_iframe").attr("src",url),!0}function _initUI(){$("input.hasCalendar").each(function(){var e={};$(this).data("noFuture")&&(e.maxDate=0),$(this).datepicker(e)}),$("input.date").each(function(){$(this).data("noFuture")&&$(this).change(function(){var e=$(this).val();10===e.length&&new Date(parseDate(e,"-"))>new Date&&errormsg(translate("FutureDateEntered"))})}),$("#maintabs ul li").hover(function(){$(this).addClass("ui-state-hover")},function(){$(this).removeClass("ui-state-hover")}),$("#admin_form").find('input[type="text"],input[type="hidden"]:not(.select-default-text),input[type="checkbox"],select:not(.dropdownmenu),textarea').change(function(){$(".save_button").addClass("ui-state-highlight")}),$(window).bind("beforeunload",function(e){if($(".save_button").hasClass("ui-state-highlight")||$(".row-add-button").hasClass("ui-state-highlight"))return e.returnValue=translate("UnsavedData"),e.returnValue}),$(document).ajaxStart(function(){$("#spinner").removeClass("hidden")}),$(document).ajaxStop(function(){$("#spinner").addClass("hidden")}),$(document).ajaxError(function(e,t){ajaxErrorHandler(t)})}function _setupListMultiSelect(){$(".print-selected-rows .print-selected-item").click(function(){var e=$(this).closest(".list_container").find(".cb-select-row:checked").map(function(){return"id[]="+encodeURIComponent(this.value)}).get(),e="invoice.php?template="+encodeURIComponent($(this).data("templateId"))+"&"+e.join("&");return"openwindow"===$(this).data("style")?window.open(e):window.location.href=e,!1})}function init(){_initUI(),_keepAliveEnabled&&window.setTimeout(_keepAlive,6e4),$(".dropdownmenu").menu({}).find("li:first").addClass("formbuttonlink ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only"),_setupSelectAll(),_setupCoverLetterForm(),_setupCustomPricesForm(),_setupListMultiSelect(),_setupFormButtons(),_initDone=!0}function _setupFormButtons(){$("a.form-submit").click(function(){var e=$(this),t=e.data("confirm");if(t&&!confirm(translate(t)))return!1;var a=e.data("form"),n=a?$("#"+a):$("form"),t=e.data("formTarget");void 0!==t&&n.attr("target",t);a=e.data("setField");return void 0!==a&&(t="1",2===(e=a.split("=",2)).length&&(a=e[0],t=e[1]),n.find("[name="+a+"]").val(t)),$(".save_button").removeClass("ui-state-highlight"),n.submit(),!1}),$("a.popup-close").click(function(){return window.close(),!1}),$("a.update-dates").click(function(){return $.getJSON("json.php?func=get_invoice_defaults",{id:$("#record_id").val(),invoice_no:$("#invoice_no").val(),invoice_date:$("#invoice_date").val(),base_id:$("#base_id").val(),company_id:$("#company_id").val(),interval_type:$("#interval_type").val()},function(e){$("#invoice_date").val(e.date),$("#due_date").val(e.due_date),$("#next_interval_date").val(e.next_interval_date),$(".save_button").addClass("ui-state-highlight")}),!1}),$("a.update-invoice-nr").click(function(){return $.getJSON("json.php?func=get_invoice_defaults",{id:$("#record_id").val(),invoice_no:$("#invoice_no").val(),invoice_date:$("#invoice_date").val(),base_id:$("#base_id").val(),company_id:$("#company_id").val(),interval_type:$("#interval_type").val()},function(e){$("#invoice_no").val(e.invoice_no),$("#ref_number").val(e.ref_no),$(".save_button").addClass("ui-state-highlight")}),!1})}function formatDate(e){e=new String(e);return 8===e.length?e.substr(6,2)+"."+e.substr(4,2)+"."+e.substr(0,4):""}function initTableExportButtons(e){new $.fn.dataTable.Buttons(e,{buttons:["copy","csv",$.extend(!0,{},{exportOptions:{format:{body:function(e,t,a,n){var i=$(n).data("export");if(void 0!==i)return i;n=$(n).data("sort");return void 0!==n?n:e}}}},{extend:"excelHtml5"}),"pdf"]}).container().appendTo($(".fg-toolbar",e.table().container()))}return{init:init,addTranslation:addTranslation,addTranslations:addTranslations,setDispatchNotePrintStyle:setDispatchNotePrintStyle,getDispatchNotePrintStyle:getDispatchNotePrintStyle,setOfferStatuses:setOfferStatuses,isOfferStatus:isOfferStatus,translate:translate,formatCurrency:formatCurrency,setKeepAlive:setKeepAlive,updateRowSelectedState:updateRowSelectedState,infomsg:infomsg,errormsg:errormsg,editUnitPrice:editUnitPrice,setCurrencyDecimals:setCurrencyDecimals,checkForUpdates:checkForUpdates,calcRowSum:calcRowSum,popupDialog:popupDialog,clearMessages:clearMessages,ajaxErrorHandler:ajaxErrorHandler,parseDate:parseDate,formatDate:formatDate,addModule:addModule,initTableExportButtons:initTableExportButtons}}();MLInvoice.addModule("Form",function(){var c={},d={},i={},r=null,s=null,l=0;function o(){-1<navigator.userAgent.toLowerCase().indexOf("android")||$("textarea.markdown").each(function(){var e=new EasyMDE({element:this,minHeight:"50px",autoDownloadFontAwesome:!1,indentWithTabs:!1,forceSync:!1,spellChecker:!1,status:!1,toolbarTips:!1,toolbar:["bold","italic",{name:"headingc",action:EasyMDE.toggleHeadingSmaller,className:"fa fa-heading",title:"Heading"},"|","quote","unordered-list","ordered-list","|","preview","side-by-side","fullscreen","|"]});e.codemirror.options.extraKeys.Tab=!1,e.codemirror.options.extraKeys["Shift-Tab"]=!1,$(this).data("mde",e),e.codemirror.on("change",function(){S(),$(".save_button").addClass("ui-state-highlight")})})}function u(){var e={};e[MLInvoice.translate("Save")]=function(){$.ajax({url:"json.php?func=update_stock_balance",type:"POST",data:{product_id:$("#record_id").val(),stock_balance_change:document.getElementById("stock_balance_change").value.replace(MLInvoice.translate("DecimalSeparator"),"."),stock_balance_change_desc:document.getElementById("stock_balance_change_desc").value},success:function(e){e.missing_fields?alert(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(e=parseFloat(e.new_stock_balance).toFixed(2).replace(".",MLInvoice.translate("DecimalSeparator")),$("#stock_balance").val(e),t(),$("#update_stock_balance").dialog("close"))}})},e[MLInvoice.translate("Close")]=function(){$("#update_stock_balance").dialog("close")},$("#update_stock_balance").dialog({modal:!0,width:400,height:240,resizable:!1,zIndex:900,buttons:e,title:MLInvoice.translate("UpdateStockBalance")})}function t(){$("#stock_balance_change_log  > tbody > tr").slice(1).remove(),$.ajax({url:"json.php?func=get_stock_balance_rows",type:"POST",data:{product_id:$("#record_id").val()},success:function(e){$("#stock_balance_change_log").append(e)}})}function p(){var e=$("#base_id.linked");""==e.val()?$("#base_id_label").text($("#base_id_label").text()):$("#base_id_label").html('<a href="index.php?func=settings&list=base&form=base&id='+e.val()+'">'+$("#base_id_label").text()+"</a>")}function f(){var e=$("#company_id.linked");0!==e.length&&(""===e.val()?$("#company_id_label").text($("#company_id_label").text()):$("#company_id_label").html('<a href="index.php?func=company&list=&form=company&id='+e.val()+'">'+$("#company_id_label").text()+"</a>"))}function v(i){$("#company_id").val(i.businessId).change(),$("#company_name").val(i.name),$.each(i.addresses,function(e,t){var a,n;1===t.version&&(1===t.type&&($("#street_address").val(t.street),$("#zip_code").val(t.postCode),$("#city").val(t.city),$("#country").val(t.country)),2===t.type&&((a=[]).push(i.name),t.careOf&&a.push("c/o "+t.careOf),t.street&&a.push(t.street),t.postCode&&(n=t.postCode+" "+t.city,a.push(n.trim())),t.country&&a.push(t.country),$("#billing_address").val(a.join("\n"))))}),$.each(i.contactDetails,function(e,t){if(1===parseInt(t.version,10))switch(t.type){case"Matkapuhelin":$("#gsm").val(t.value);break;case"Kotisivun www-osoite":$("#www").val(t.value);break;case"Puhelin":$("#phone").val(t.value);break;case"Faksi":$("#fax").val(t.value)}})}function m(){$(".select-default-text").each(function(){var a=$(this).data("target"),n=$(this).data("sendFormParam"),t=$('<input type="hidden" class="select-default-text"/>').appendTo($(this));t.select2({placeholder:"",ajax:{url:"json.php",dataType:"json",quietMillis:200,data:function(e,t){return{func:"get_selectlist",table:"default_value",q:e,type:$(this).parent().data("type"),pagelen:50,page:t}},results:function(e){return{results:e.records,more:e.moreAvailable}}},dropdownCssClass:"bigdrop",dropdownAutoWidth:!0,escapeMarkup:function(e){return e},width:"element",minimumResultsForSearch:-1}),t.on("change",function(){var e=t.select2("val");e&&(t.select2("val",null),$.ajax({url:"json.php",data:{func:"get_default_value",id:e}}).done(function(e){var t;n?((t=$('<input type="hidden"/>')).attr("name",n),t.attr("value",e.id),$("#"+a).append(t),$("#"+a).submit()):(t=$("#"+a).data("mde"))?t.value(e.content):($("#"+a).val(e.content),$("#"+a).change())}).fail(function(e,t){window.alert("Request failed: "+e.status+" - "+t)}))})})}function _(e){var r={_onChangeCompany:h,_onChangeCompanyOffer:a,_onChangeProduct:n,_onChangeCompanyReload:g};$(void 0===e?"body":e).find(".select2").each(function(){var a=$(this),n=a.hasClass("tags"),i=a.data("query"),o=a.data("showEmpty"),e=a.data("onChange"),t={placeholder:"",ajax:{url:"json.php?func=get_selectlist&"+i,dataType:"json",quietMillis:200,data:function(e,t){e={q:e,pagelen:50,page:t};return"iform_product_id"!==a[0].id||(t=$("#company_id")).length&&t.val()&&(e.company=t.val()),e},results:function(e,t){var a=[];return n?$(e.records).each(function(){a.push({id:this.text,text:this.text,descriptions:[]})}):a=e.records,o&&1===t&&""===e.filter&&a.unshift({id:"",text:"-"}),{results:a,more:e.moreAvailable}}},initSelection:function(e,t){e=$(e).val();""!==e&&$.ajax("json.php?func=get_selectlist&"+i+"&id="+e,{dataType:"json"}).done(function(e){t(e.records[0])})},formatResult:function(e){var t=e.text;return $(e.descriptions).each(function(){t+='<div class="select-description">'+this+"</div>"}),t},dropdownCssClass:"bigdrop",dropdownAutoWidth:!0,escapeMarkup:function(e){return e},width:"element"};n&&$.extend(t,{tags:!0,tokenSeparators:[","],createSearchChoice:function(e){return{id:$.trim(e),text:$.trim(e)+" (+)"}},initSelection:function(e,t){var a=[],e=e.val();if(!e)return a;$(e.split(",")).each(function(){""!==$.trim(this)&&a.push({id:this,text:this})}),t(a)},formatSelection:function(e){e=(e=e.text).replace(/ \(\+\)$/,"");return $("<div/>").text(e).html()}});t=a.select2(t);e&&"function"==typeof r[e]&&t.change(r[e])})}function h(e){var t=void 0===e;$("#invoice_vatless").val("0"),y(""),$.getJSON("json.php?func=get_company",{id:$("#company_id").val()},function(e){e&&(t||(e.default_ref_number&&$("#ref_number").val(e.default_ref_number),e.delivery_terms_id&&$("#delivery_terms_id").val(e.delivery_terms_id),e.delivery_method_id&&$("#delivery_method_id").val(e.delivery_method_id),e.payment_days&&$.getJSON("json.php?func=get_invoice_defaults",{id:$("#record_id").val(),invoice_no:$("#invoice_no").val(),invoice_date:$("#invoice_date").val(),base_id:$("#base_id").val(),company_id:$("#company_id").val(),interval_type:$("#interval_type").val()},function(e){$("#due_date").val(e.due_date)}),$("#delivery_address").val(e.delivery_address||"")),e.info&&y(e.info),e.invoice_default_foreword&&$("#foreword").val(e.invoice_default_foreword),e.invoice_default_afterword&&$("#afterword").val(e.invoice_default_afterword),e.invoice_vatless&&$("#invoice_vatless").val("1"))})}function a(){y(""),$.getJSON("json.php?func=get_company",{id:$("#company_id").val()},function(e){e&&(e.info&&y(e.info),e.offer_default_foreword&&$("#foreword").val(e.offer_default_foreword),e.offer_default_afterword&&$("#afterword").val(e.offer_default_afterword))})}function n(){var o,e;""!==this.value&&(o=this.form.id,e=$("#company_id").val(),$.getJSON("json.php?func=get_product&id="+this.value+"&company_id="+e,function(e){if((r=e)&&e.id){""===e.description&&document.getElementById(o+"_description").value!==(null!==s?s:"")||(document.getElementById(o+"_description").value=e.description),s=e.description;for(var t=document.getElementById(o+"_type_id"),a=0;a<t.options.length;a++){var n=t.options[a];if(n.value===(null===e.type_id?"":String(e.type_id))){n.selected=!0;break}}var i=(e.custom_price&&null!==e.custom_price.unit_price?e.custom_price:e).unit_price;document.getElementById(o+"_price").value=e.unit_price?MLInvoice.formatCurrency(i):"",document.getElementById(o+"_discount").value=e.discount?e.discount.replace(".",","):"",document.getElementById(o+"_discount_amount").value=e.discount_amount?MLInvoice.formatCurrency(e.discount_amount):"","0"===$("#invoice_vatless").val()?(document.getElementById(o+"_vat").value=e.vat_percent?e.vat_percent.replace(".",","):"",document.getElementById(o+"_vat_included").checked=!(!e.vat_included||1!==e.vat_included)):(document.getElementById(o+"_vat").value="0",document.getElementById(o+"_vat_included").checked=!1)}}))}function g(){var e=(e=window.location.href).replace(/[\\?&]company=\d*/,"");e+=0<=e.indexOf("?")?"&":"?",e+="company="+this.value,window.location.href=e}function y(e){e?$("<span/>").addClass("info ui-state-highlight ui-corner-all").attr("title",e).text(" ").click(function(){alert(e)}).appendTo($("#company_id_label")):$("#company_id_label>span.info").remove()}function b(){var e,o=$(".send-buttons");0!==o.length&&(o.html(""),""!==(e=String($("#base_id").val()))&&$.getJSON("json.php?func=get_send_api_services",{invoice_id:String($("#record_id").val()),base_id:e},function(e){$.each(e.services,function(e,t){var a=$('<ul class="dropdownmenu"/>'),n=$("<li/>");n.text(t.name+"..."),a.append(n);var i=$("<ul/>");$.each(t.items,function(e,t){var a=$("<li/>");a.click(function(){!function(e){if(!w())return;void 0===$("#admin_form").data("readOnly")?MLInvoice.Form.saveRecord(e,"",!0):window.location.href=e}("?"+t.href)});var n=$("<div>");n.text(t.name),a.append(n),i.append(a)}),n.append(i),o.append(a),o.append(" ")}),$(".send-buttons .dropdownmenu").each(function(){$(this).menu({}).find("li:first").addClass("formbuttonlink ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only")})}))}function w(){var e=$("#admin_form");if(void 0!==e.data("checkInvoiceDate")){var t=new Date,a=$("#invoice_date").val().split(".");if((parseInt(a[0],10)!==t.getDate()||parseInt(a[1],10)!==t.getMonth()+1||parseInt(a[2],10)!==t.getYear()+1900)&&!confirm(MLInvoice.translate("InvoiceDateNonCurrent")))return}if(!MLInvoice.isOfferStatus($("#state_id").val())){t=$("#ref_number").val().length;if(0<t&&t<4&&!confirm(MLInvoice.translate("InvoiceRefNumberTooShort")))return;if(void 0!==e.data("checkInvoiceNumber")){e=String($("#invoice_no").val());if((""===e||"0"===e)&&!confirm(MLInvoice.translate("InvoiceNumberNotDefined")))return}}return 1}function T(){var e=$("#attachments-form").data("invoiceId"),r=$("<div/>");l=0,$.getJSON("json.php?func=get_invoice_attachments&parent_id="+e,function(e){var o=0;$.each(e.records,function(e,t){o+=1,t.order_no>l&&(l=t.order_no);var a=$("<div/>").addClass("attachment");$("<a/>").addClass("tinyactionlink ui-button ui-corner-all ui-widget remove-attachment").text(" X ").attr("title",MLInvoice.translate("RemoveAttachment")).click(function(){$.getJSON("json.php?func=delete_invoice_attachment&id="+t.id,function(){T()})}).appendTo(a);var n=$("<input>").attr("type","checkbox").data("id",t.id).prop("checked",t.send);n.change(function(){$.ajax({url:"json.php?func=put_invoice_attachment",data:{id:$(this).data("id"),send:$(this).prop("checked")?"1":"0"},type:"POST",dataType:"json"})});var i=$("<label/>").addClass("attachment-send");n.appendTo(i),$("<span/>").text(MLInvoice.translate("SendToClient")).appendTo(i),i.appendTo(a);n=$("<input/>").addClass("attachment-name").attr("type","text").data("id",t.id).val(t.name).attr("placeholder",MLInvoice.translate("Description"));n.change(function(){$.ajax({url:"json.php?func=put_invoice_attachment",data:{id:$(this).data("id"),name:$(this).val()},type:"POST",dataType:"json"})}),n.appendTo(a);i=$("<div/>").addClass("attachment-fileinfo");$("<a/>").attr("href","attachment.php?type=invoice&id="+t.id).attr("target","_blank").text(t.filename).appendTo(i);n=$("<span/>").text(" ("+t.filesize_readable+")");1048576<t.filesize&&(n.addClass("large-file"),n.attr("title",MLInvoice.translate("LargeFile"))),n.appendTo(i),i.appendTo(a),a.appendTo(r)}),0===o&&r.text(MLInvoice.translate("NoEntries")),$(".attachment-list").empty().append(r),$(".attachment-count").text(o)})}function S(){"invoice"===c.type&&!c.modificationWarningShown&&c.modificationWarning&&(alert(c.modificationWarning),c.modificationWarningShown=!0)}function I(){b();var e=String($("#base_id").val());""!==e&&$.ajax({url:"json.php?func=get_base",data:{id:e},type:"GET",success:function(a){var e=$("#state_id").val();$.ajax({url:"json.php?func=get_invoice_state",data:{id:e},type:"GET",success:function(e){var t;0!=e.invoice_open&&(e=1==e.invoice_offer?"offer":"invoice",a[e+"_default_foreword"]&&(""!==(t=$("#foreword").val())&&t!==a.invoice_default_foreword&&t!==a.offer_default_foreword||$("#foreword").val(a[e+"_default_foreword"])),a[e+"_default_afterword"]&&(""!==(t=$("#afterword").val())&&t!==a.invoice_default_afterword&&t!==a.offer_default_afterword||$("#afterword").val(a[e+"_default_afterword"])),a.invoice_default_info&&""==$("#info").val()&&$("#info").val(a.invoice_default_info))}})}})}return{initForm:function(e,t,a){var n;d=t,i=a,(c=e).modificationWarningShown=!1,$("#admin_form").find('input[type="text"]:not([name="payment_date"]),input[type="hidden"],input[type="checkbox"]:not([name="archived"]),select:not(.dropdownmenu),textarea').one("change",S),$(".save_button").click(function(){return MLInvoice.Form.saveRecord(),!1}),$("#base_id").change(I),$("#state_id").change(I),$("#company_id.select2").val()&&h(),$(".update-stock-balance").click(function(){return u(),!1}),$("#base_id.linked").change(p),p($("#base_id.linked")),$("#company_id.linked").change(f),f($("#company_id.linked")),0!==(e=$("a.ytj_search_button")).length&&e.click(function(){var e,a=(a=$("#company_id").val())||$("#company_name").val();""!==(a=window.prompt(MLInvoice.translate("SearchYTJPrompt"),a))&&null!==a&&(e=a.replace(/FI-?/i,""),$.ajax({url:"https://avoindata.prh.fi/bis/v1",data:{maxResults:1,businessId:e},global:!1}).done(function(e){void 0!==e.results[0]&&v(e.results[0])}).fail(function(e,t){404===e.status?$.ajax({url:"https://avoindata.prh.fi/bis/v1",data:{maxResults:1,name:a},global:!1}).done(function(e){void 0!==e.results[0]&&v(e.results[0])}).fail(function(e,t){404===e.status?window.alert(MLInvoice.translate("NoYTJResultsFound")):window.alert("Request failed: "+e.status+" - "+t)}):window.alert("Request failed: "+e.status+" - "+t)}))}),o(),m(),_(),n=$("#attachments-form").data("invoiceId"),$("#attachments-button").click(function(){$("#attachments-form").hasClass("hidden")&&T(),$("#attachments-button .dropdown-open").toggleClass("hidden"),$("#attachments-button .dropdown-close").toggleClass("hidden"),$("#attachments-form").toggleClass("hidden")}),$("a.add-attachment").click(function(){$.ajax({url:"json.php?func=add_invoice_attachment&id="+$(this).data("id")+"&invoice_id="+n,type:"POST",dataType:"json",success:function(){T()}})}),$("#new-attachment-file").change(function(){var e;0<this.files.length&&((e=new FormData).append("filedata",this.files[0]),e.append("invoice_id",n),e.append("order_no",l+5),$.ajax({url:"json.php?func=put_invoice_attachment",type:"POST",dataType:"json",data:e,processData:!1,contentType:!1,success:function(e){e.warnings&&alert(e.warnings),e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):T()}}),$(this).val(null))}),b()},initAddressAutocomplete:function(a){var t,n=document.getElementById(a+"street_address");null!==n&&($(n).attr("placeholder",""),$(n).blur(function(){var e=$(n).val();setTimeout(function(){$(n).val(e)},0)}),t=new google.maps.places.Autocomplete(n,{types:["geocode"]}),google.maps.event.addListener(t,"place_changed",function(){var e=t.getPlace();setTimeout(function(){$("#"+a+"street_address").val(e.name),$.each(e.address_components,function(e,t){0<=$.inArray("postal_code",t.types)?$("#"+a+"zip_code").val(t.long_name).trigger("change"):0<=$.inArray("locality",t.types)||0<=$.inArray("administrative_area_level_3",t.types)?$("#"+a+"city").val(t.long_name).trigger("change"):0<=$.inArray("country",t.types)&&$("#"+a+"country").val(t.long_name).trigger("change")})},0)}))},saveRecord:function(a,n,i){MLInvoice.clearMessages();var o=$("#admin_form"),r=new FormData;$.each(c.fields,function(e,t){var a,n=o.find("[name="+t.name+"]");switch(t.type){case"CHECK":r.append(t.name,n.prop("checked"));break;case"INT":r.append(t.name,n.val().replace(MLInvoice.translate("DecimalSeparator"),"."));break;case"FILE":0<n.get(0).files.length&&r.append(t.name,n.get(0).files[0]);break;case"SELECT":case"SEARCHLIST":case"INTDATE":case"LIST":case"TEXT":case"PASSWD":case"TAGS":r.append(t.name,n.val());break;case"AREA":n.hasClass("markdown")?(a=n.data("mde"),r.append(t.name,void 0!==a?a.value():n.val())):r.append(t.name,n.val())}}),r.append("id",o.find("#record_id").val()),void 0!==i&&r.append("onPrint",i),$.ajax({url:"json.php?func=put_"+c.type,type:"POST",dataType:"json",data:r,processData:!1,contentType:!1,success:function(e){var t;e.warnings&&alert(e.warnings),e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):("invoice"===c.type&&void 0!==i&&i&&($("input#invoice_no").val(e.invoice_no),$("input#ref_number").val(e.ref_number)),$(".save_button").removeClass("ui-state-highlight"),MLInvoice.infomsg(MLInvoice.translate("RecordSaved"),2e3),a&&("openwindow"===n?window.open(a):window.location=a),o.find("#record_id").val()||(o.find("#record_id").val(e.id),a&&"openwindow"!==n||(t=new String(window.location).split("#",1)[0],window.location=t+"&id="+e.id)))}})},initRows:function(o){$(".cb-select-all").prop("checked",!1);var e="";switch(d.type){case"company":e="get_companies";break;case"company_contact":e="get_company_contacts";break;case"invoice_row":e="get_invoice_rows";break;case"send_api_config":e="get_send_api_configs"}var r=c.readOnly,s=c.type,l=c.id,u=d,p=i,f=this;$.getJSON("json.php?func="+e+"&parent_id="+c.id,function(e){var t,a,n,i=$("#itable");$("#itable > tbody > tr[id!=form_row]").remove(),$.each(e.records,function(e,c){var t,a,d=$("<tr/>").addClass("item-row");r||"invoice"!==s||($('<td class="sort-col"><span class="sort-handle hidden"><i class="fa fa-sort"></i><span class="sr-only">'+MLInvoice.translate("Sort")+"</span></span>").appendTo(d),a=MLInvoice.translate("SelectRow"),(t=$("<input/>").addClass("cb-select-row").attr("type","checkbox").attr("title",a).attr("aria-label",a).click(function(){MLInvoice.updateRowSelectedState($(this).closest(".list_container"))})).val(c.id),(a=$('<td class="select-row"/>')).append(t),d.append(a)),$.each(u.fields,function(e,t){var a=$("<td/>").addClass(t.style+(c.deleted?" deleted":""));a.data("field",t.name);var n=c[t.name];switch(t.type){case"LIST":case"SEARCHLIST":var i=t.name+"_text",o="",o=void 0!==c[i]&&null!==c[i]||void 0===p[t.name][n]?c[i]:p[t.name][n];"invoice_row"===u.type&&"product_id"===t.name?null!==n&&(s=$("<a/>").attr("href","?func=settings&list=product&form=product&listid=list_product&id="+c[t.name]).text(o),a.append(s)):a.text(o),a.appendTo(d);break;case"PASSWD_STORED":a.text(""),a.appendTo(d);break;case"INT":void 0!==t.decimals?a.text(n?MLInvoice.formatCurrency(n,t.decimals):""):a.text(n?String(n).replace(".",MLInvoice.translate("DecimalSeparator")):""),a.appendTo(d);break;case"INTDATE":a.text(null!==n?MLInvoice.formatDate(n):""),a.appendTo(d);break;case"CHECK":a.text(MLInvoice.translate(n?"YesButton":"NoButton")),a.appendTo(d);break;case"ROWSUM":var r=MLInvoice.calcRowSum(c),s=MLInvoice.formatCurrency(r.sum),o=MLInvoice.formatCurrency(r.VAT),r=MLInvoice.formatCurrency(r.sumVAT),o=MLInvoice.translate("VATLess")+": "+s+" &ndash; "+MLInvoice.translate("VATPart")+": "+o,r=$("<span/>").attr("title",o).text(r);a.append(r),a.appendTo(d);break;case"TAGS":r=(r=n?String(n):"").replace(new RegExp(/,/,"g"),", ");a.text(r),a.appendTo(d);break;case"TEXT":case"AREA":a.text(n||""),a.appendTo(d)}}),r||(a=$("<a/>").addClass("tinyactionlink ui-button ui-corner-all ui-widget row-edit-button").attr("href","#").text(MLInvoice.translate("Edit")).click(function(e){return f.popupEditor(e,MLInvoice.translate("RowModification"),c.id,!1),!1}),$("<td/>").addClass("button").append(a).appendTo(d),"invoice_row"===u.type&&c.reminder_row||(a=$("<a/>").addClass("tinyactionlink ui-button ui-corner-all ui-widget row-copy-button").attr("href","#").data("id",l).text(MLInvoice.translate("Copy")).click(function(e){return f.popupEditor(e,MLInvoice.translate("RowCopy"),c.id,!0),!1}),$("<td/>").addClass("button").append(a).appendTo(d))),i.append(d)}),"invoice_row"===u.type&&(t=function(e){for(var t=0,a=0,n=0,i=0,o=0,r=0;r<e.length;r++){var s,c,d,l,u,p,f=e[r];f.partial_payment?o+=parseFloat(f.price):(s=f.pcs,c=f.price,u=f.discount||0,p=f.discount_amount||0,d=f.vat,l=f.vat_included,null!==f.product_weight&&(i+=s*parseFloat(f.product_weight)),c*=1-u/100,c-=p,p=u=f=0,1==l?p=(u=s*c)-(f=u/(1+d/100)):u=(f=s*c)+(p=f*(d/100)),t+=f,a+=p,n+=u)}return{totSum:t,totVAT:a,totSumVAT:n,totWeight:i,partialPayments:o}}(e.records),a=$("<tr/>").addClass("summary"),n=$("<td/>").addClass("input").attr("colspan","6").attr("rowspan","2"),r||(n.text(MLInvoice.translate("ForSelected")+": "),$("<button/>").attr("id","delete-selected-rows").addClass("selected-row-button ui-button ui-corner-all ui-widget").text(MLInvoice.translate("Delete")).click(function(){return f.deleteSelectedRows(),!1}).appendTo(n),n.append($("<span/>").text(" ")),$("<button/>").attr("id","update-selected-rows").addClass("selected-row-button ui-button ui-corner-all ui-widget").text(MLInvoice.translate("Modify")).click(function(e){return f.multiEditor(e,MLInvoice.translate("ModifySelectedRows")),!1}).appendTo(n)),n.appendTo(a),$("<td/>").addClass("input").attr("colspan","6").attr("align","right").text(MLInvoice.translate("TotalExcludingVAT")).appendTo(a),$("<td/>").addClass("input currency").attr("align","right").text(MLInvoice.formatCurrency(t.totSum)).appendTo(a),$("<td/>").attr("colspan","2").appendTo(a),i.append(a),a=$("<tr/>").addClass("summary"),$("<td/>").addClass("input").attr("colspan","6").attr("align","right").text(MLInvoice.translate("TotalVAT")).appendTo(a),$("<td/>").addClass("input currency").attr("align","right").text(MLInvoice.formatCurrency(t.totVAT)).appendTo(a),$("<td/>").attr("colspan","2").appendTo(a),i.append(a),a=$("<tr/>").addClass("summary"),$("<td/>").addClass("input").attr("colspan","12").attr("align","right").text(MLInvoice.translate("TotalIncludingVAT")).appendTo(a),$("<td/>").addClass("input currency").attr("align","right").text(MLInvoice.formatCurrency(t.totSumVAT)).appendTo(a),$("<td/>").attr("colspan","2").appendTo(a),i.append(a),a=$("<tr/>").addClass("summary"),$("<td/>").addClass("input").attr("colspan","12").attr("align","right").text(MLInvoice.translate("TotalToPay")).appendTo(a),$("<td/>").addClass("input currency").attr("align","right").text(MLInvoice.formatCurrency(t.totSumVAT+t.partialPayments)).appendTo(a),$("<td/>").attr("colspan","2").appendTo(a),i.append(a),0<t.totWeight&&(a=$("<tr/>").addClass("summary"),$("<td/>").addClass("input").attr("colspan","12").attr("align","right").text(MLInvoice.translate("ProductWeight")).appendTo(a),$("<td/>").addClass("input currency").attr("align","right").text(MLInvoice.formatCurrency(t.totWeight,3)).appendTo(a),$("<td/>").attr("colspan","2").appendTo(a),i.append(a))),MLInvoice.updateRowSelectedState(),$("#itable tr").mouseover(function(){$(this).find(".sort-handle").removeClass("hidden")}).mouseout(function(){$(this).find(".sort-handle").addClass("hidden")}),r||"invoice"!==s||$("#itable > tbody").sortable({axis:"y",handle:".sort-col",items:"tr.item-row",stop:function(){f.updateRowOrder()}}),$("#iform").find('input[type="text"],input[type="hidden"],input[type="checkbox"]:not(.cb-select-row):not(.cb-select-all),select:not(.dropdownmenu),textarea').change(function(){$(".row-add-button").addClass("ui-state-highlight")}),$("#iform").find('input[type="text"],input[type="hidden"],input[type="checkbox"],select:not(.dropdownmenu),textarea').one("change",S),$("#iform_popup").find('input[type="text"],input[type="hidden"]:not(.select-default-text),input[type="checkbox"],select:not(.dropdownmenu),textarea').change(function(){$(this).parent().find(".modification-indicator").removeClass("hidden"),$(this).data("modified",1)}),void 0!==o&&o(),u.dispatchByDateButtons&&f.updateDispatchByDateButtons(e.records)})},updateRowOrder:function(){var e={};e.table=d.type,e.order={};var t=1;$(".cb-select-row").each(function(){e.order[this.value]=t,t+=1}),$.ajax({url:"json.php?func=update_row_order",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(){MLInvoice.Form.initRows()}})},saveRow:function(o){MLInvoice.clearMessages();var r=$("#"+o),i={};$.each(d.fields,function(e,t){var a,n=r.find("[name="+o+"_"+t.name+"]");switch(t.type){case"CHECK":i[t.name]=n.prop("checked");break;case"INT":i[t.name]=n.val().replace(MLInvoice.translate("DecimalSeparator"),".");break;case"TAGS":case"SEARCHLIST":case"INTDATE":case"LIST":case"TEXT":case"PASSWD":case"PASSWD_STORED":i[t.name]=n.val();break;case"AREA":n.hasClass("markdown")?(a=n.data("mde"),i[t.name]=void 0!==a?a.value():n.val()):i[t.name]=n.val()}}),i[d.parentKey]=c.id;var e=r.data("rowId");e&&(i.id=e);var s=d,t=this;$.ajax({url:"json.php?func=put_"+d.type,type:"POST",dataType:"json",data:JSON.stringify(i),contentType:"application/json; charset=utf-8",success:function(e){e.error?MLInvoice.errormsg(e.error):e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(MLInvoice.infomsg(MLInvoice.translate("RecordSaved"),2e3),r.find(".row-add-button").removeClass("ui-state-highlight"),t.initRows(),r.data("popup")&&$("#popup_edit").dialog("close"),i.id||(""!==s.onAfterRowAdded&&s.onAfterRowAdded(),$.each(s.fields,function(e,t){var a,n=r.find("[name="+o+"_"+t.name+"]");if(void 0!==t.default&&String(t.default).startsWith("ADD+"))n.val(parseInt(n.val(),10)+parseInt(String(t.default).substr(4)));else if(void 0!==t.default&&"DATE_NOW"===t.default){var i=(new Date).toISOString().replace(/-/g,"").substr(0,8);n.val(MLInvoice.formatDate(i))}else if(s.clearAfterRowAdded)switch(t.type){case"LIST":n.val([]);break;case"SEARCHLIST":n.select2("val","");break;case"CHECK":n.prop("checked",!1);break;case"INT":case"INTDATE":case"TEXT":n.val("");break;case"AREA":n.hasClass("markdown")&&void 0!==(a=n.data("mde"))?a.value(""):n.val("")}})))}})},deleteRow:function(e){var t=$("#"+e).data("rowId");$.ajax({url:"json.php?func=delete_"+d.type+"&id="+t,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:function(){MLInvoice.Form.initRows(),"iform_popup"==e&&$("#popup_edit").dialog("close")}})},deleteSelectedRows:function(){var e={};e.id=$(".cb-select-row:checked").map(function(){return this.value}).get(),$.ajax({url:"json.php?func=delete_"+d.type,type:"POST",dataType:"json",data:e,success:function(){MLInvoice.Form.initRows()}})},popupEditor:function(e,t,a,c){S(),$("#iform_popup .modification-indicator").addClass("hidden"),$("#iform_popup input").data("modified","");var n=d,i=this;$.getJSON("json.php?func=get_"+d.type+"&id="+a,function(r){var s,e;r.id&&(s=$("#iform_popup"),c?s.data("rowId",""):s.data("rowId",a),$.each(n.fields,function(e,t){var a,n=s.find("[name=iform_popup_"+t.name+"]");switch(t.type){case"CHECK":n.prop("checked",r[t.name]?1:0);break;case"INT":c&&t.default&&-1!==t.default.indexOf("ADD")?n.val(parseInt(r[t.name],10)+5):void 0!==t.decimals?n.val(r[t.name]?MLInvoice.formatCurrency(r[t.name],t.decimals):""):n.val(r[t.name]?String(r[t.name]).replace(".",MLInvoice.translate("DecimalSeparator")):"");break;case"SEARCHLIST":var i={id:r[t.name],text:r[t.name+"_text"]};n.select2("data",i);break;case"INTDATE":n.val(r[t.name]?MLInvoice.formatDate(r[t.name]):"");break;case"PASSWD_STORED":n.val("");break;case"TAGS":var o=[];$(r[t.name].split(",")).each(function(){o.push({id:this,text:this})}),n.select2("data",o);break;case"LIST":case"TEXT":n.val(r[t.name]);break;case"AREA":n.hasClass("markdown")&&void 0!==(a=n.data("mde"))?a.value(r[t.name]):n.val(r[t.name])}}),_($("#popup_edit")),(e={})[MLInvoice.translate("Save")]=function(){i.saveRow("iform_popup")},c||(e[MLInvoice.translate("Delete")]=function(){return!0===confirm(MLInvoice.translate("ConfirmDelete"))&&i.deleteRow("iform_popup"),!1}),e[MLInvoice.translate("Close")]=function(){$("#popup_edit").dialog("close")},$("#popup_edit").dialog({modal:!0,width:n.popupWidth,height:180,resizable:!0,buttons:e,title:t}))})},multiEditor:function(e,t){S(),$("#iform_popup .modification-indicator").addClass("hidden"),$("#iform_popup input").data("modified",0),$("#iform_popup select").data("modified",0);var i=$("#iform_popup");$.each(d.fields,function(e,t){var a,n=i.find("[name=iform_popup_"+t.name+"]");switch(t.type){case"CHECK":n.prop("checked",!1);break;case"SEARCHLIST":n.select2("data",{});break;case"TAGS":n.select2("data",[]);break;case"PASSWD_STORED":case"INT":case"INTDATE":case"LIST":case"TEXT":n.val("");break;case"AREA":n.hasClass("markdown")&&void 0!==(a=n.data("mde"))?a.value(""):n.val("")}}),i.find(".modification-indicator").addClass("hidden"),_($("#popup_edit"));var a={},n=this;a[MLInvoice.translate("Save")]=function(){n.modifyRows("iform_popup")},a[MLInvoice.translate("Close")]=function(){$("#popup_edit").dialog("close")},$("#popup_edit").dialog({modal:!0,width:d.popupWidth,height:180,resizable:!0,buttons:a,title:t})},modifyRows:function(i){MLInvoice.clearMessages();var o=$("#"+i),r={};$.each(d.fields,function(e,t){var a,n=o.find("[name="+i+"_"+t.name+"]");if(n.data("modified"))switch(t.type){case"CHECK":r[t.name]=n.prop("checked");break;case"INT":r[t.name]=n.val().replace(MLInvoice.translate("DecimalSeparator"),".");break;case"SEARCHLIST":r[t.name]=n.select2("data");break;case"LIST":case"INTDATE":case"TEXT":r[t.name]=n.val();break;case"AREA":n.hasClass("markdown")?(a=n.data("mde"),r[t.name]=void 0!==a?a.value():n.val()):r[t.name]=n.val()}});var e={};e.table=d.type,e.ids=$("#iform .cb-select-row:checked").map(function(){return this.value}).get(),e.changes=r,$.ajax({url:"json.php?func=update_multiple",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):($("#popup_edit").dialog("close"),MLInvoice.Form.initRows())}})},addCompany:function(a){var e={};e[a.save]=function(){var t,e;t=a,(e={}).company_name=document.getElementById("quick_name").value,e.email=document.getElementById("quick_email").value,e.phone=document.getElementById("quick_phone").value,e.street_address=document.getElementById("quick_street_address").value,e.zip_code=document.getElementById("quick_zip_code").value,e.city=document.getElementById("quick_city").value,e.country=document.getElementById("quick_country").value,$.ajax({url:"json.php?func=put_company",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){e.missing_fields?alert(t.missing+e.missing_fields):(e=e.id,$.getJSON("json.php?func=get_company",{id:e},function(e){var t=e.company_name;e.company_id&&(t+=" ("+e.company_id+")");var a=$("#company_id");a.select2("data",{id:e.id,text:t}),a.trigger("change")}),$("#quick_add_company").dialog("close"))}})},e[a.close]=function(){$("#quick_add_company").dialog("close")},$("#quick_add_company").dialog({modal:!0,width:420,height:320,resizable:!1,zIndex:900,buttons:e,title:a.title})},addPartialPayment:function(){var e={};e[MLInvoice.translate("Save")]=function(){var e;(e={}).invoice_id=$("#record_id").val(),e.description=MLInvoice.translate("PartialPayment"),e.row_date=$("#add_partial_payment_date").val(),e.price=-parseFloat($("#add_partial_payment_amount").val().replace(MLInvoice.translate("DecimalSeparator"),".")),e.pcs=0,e.vat=0,e.vat_included=0,e.order_no=1e5,e.partial_payment=1,$.ajax({url:"json.php?func=put_invoice_row",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){e.missing_fields?alert(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(MLInvoice.Form.initRows(),$("#add_partial_payment").dialog("close"))}})},e[MLInvoice.translate("Close")]=function(){$("#add_partial_payment").dialog("close")},$("#add_partial_payment").dialog({modal:!0,width:420,height:160,resizable:!1,zIndex:900,buttons:e,title:MLInvoice.translate("PartialPayment")})},getSelectedProductDefaults:function(e){if(null!==r){document.getElementById(e+"_description").value=r.description,s=r.description;for(var t=document.getElementById(e+"_type_id"),a=0;a<t.options.length;a++){var n=t.options[a];if(n.value===r.type_id){n.selected=!0;break}}document.getElementById(e+"_price").value=r.unit_price.replace(".",","),document.getElementById(e+"_discount").value=r.discount.replace(".",","),document.getElementById(e+"_vat").value=r.vat_percent.replace(".",","),document.getElementById(e+"_vat_included").checked=1===r.vat_included}},updateStockBalance:u,updateStockBalanceLog:t,printInvoice:function(e,t,a,n){if(w()){t="invoice.php?id="+$("#record_id").val()+"&template="+e+"&func="+t;return void 0!==n&&(t+="&date="+n),void 0===$("#admin_form").data("readOnly")?MLInvoice.Form.saveRecord(t,a,!0):"openwindow"===a?window.open(t):window.location.href=t,!1}},updateDispatchByDateButtons:function(e){if("none"!==MLInvoice.getDispatchNotePrintStyle()&&!MLInvoice.isOfferStatus($("#state_id").val())){var t=$("#dispatch_date_buttons");t.empty();var a=[];$.each(e,function(e,t){return!(!t.reminder_row&&!t.partial_payment)||void(-1===a.indexOf(t.row_date)&&a.push(t.row_date))}),a.sort();function n(){s.printInvoice(2,"open_invoices",MLInvoice.getDispatchNotePrintStyle(),$(this).data("date"))}var i,o,r,s=this;for(i in a)a.hasOwnProperty(i)&&(o=$('<a class="formbuttonlink ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only"/>'),r=a[i],o.data("date",r),o.click(n),$('<span class="ui-button-text"/>').text(MLInvoice.translate("SettingDispatchNotes")+" "+MLInvoice.formatDate(r)).appendTo(o),t.append(o),t.append(" "))}},setupSelect2:_,setupDefaultTextSelection:m,setupMarkdownEditor:o}});
//# sourceMappingURL=mlinvoice.min.js.map