/*! mlinvoice 2022-05-01 */

var MLInvoice=function(){var a=[],n=!1,o={},t="none",i=[],r=!0,c=2,d={},s="DD.MM.YYYY";function l(e,t){o[e]=t}function p(e,t,a){var n=o[e]||e;return n===e&&void 0!==a&&(n=a),"object"==typeof t&&$.each(t,function(e,t){n=n.replace(new RegExp(e,"g"),t)}),n}function u(e){return new String(e).replace(",",".")}function f(e,t){var a=void 0===t?c:t,t=p("DecimalSeparator"),n=p("ThousandSeparator",[],""),a=parseFloat(e).toFixed(a).replace(".",t);if(n){for(var o=a.split(t),i=new RegExp("(\\d+)(\\d{3})"+t+"?");i.test(o[0]);)o[0]=o[0].replace(i,"$1"+n+"$2");a=o[0],1<o.length&&(a+=t+o[1])}return a}function e(){$.getJSON("json.php?func=noop").done(function(){window.setTimeout(e,6e4)})}function v(e){return $("#spinner").addClass("hidden"),409==e.status?_(JSON.parse(e.responseText).warnings):_(p("ServerError")+": "+e.status+" - "+e.statusText),!1}function m(e){e=void 0===e?$("body"):$(e);0===e.find(".cb-select-row:checked").length?(e.find(".selected-row-button").attr("disabled","disabled"),e.find(".selected-row-button").addClass("disabled")):(e.find(".selected-row-button").removeAttr("disabled"),e.find(".selected-row-button").removeClass("disabled"))}function h(e,t,a){var n=$('<div class="toast align-items-center" role="alert" aria-live="polite" aria-atomic="true">');void 0!==a?n.addClass(a):n.addClass("text-white bg-success");a=$('<div class="d-flex">').appendTo(n);$('<div class="toast-body">').text(e).appendTo(a),$('<button type="button" class="btn-close m-auto me-2" data-bs-dismiss="toast">').attr("aria-label",p("Close")).appendTo(a);a=$("#toasts");0===a.length&&(a=$('<div id="toasts" aria-live="polite" class="toast-container position-fixed p-3 top-0 end-0" style="z-index: 5">').appendTo($("body"))),n.appendTo(a);t={autohide:void 0!==t,delay:void 0!==t?t:0};new bootstrap.Toast(n.get(0),t).show()}function _(e,t){h(e,t,"text-white bg-danger")}function g(e){var t;void 0!==e.version&&(t=p("UpdateAvailableTitle",{"{version}":e.version,"{date}":b(e.date)}),t=$("<span/>").attr("title",t).text(p("UpdateAvailable")+" "),$("<br>").appendTo(t),$("<a>").attr("href",e.url).attr("target","_blank").text(p("UpdateInformation")).appendTo(t),$("<br>").appendTo(t),$("<a>").attr("href","index.php?func=system&operation=update").text(p("UpdateNow")).appendTo(t),t.appendTo("#version")),Cookies.set("updateversion",JSON.stringify(e),{expires:1})}function y(e){var t=$("#popup_dlg .modal-body");t.html(e),t.find("form").on("submit",function(e){var t=$(this),a=t.attr("method")||"GET",n=t.attr("action")||"",t=new FormData(this);return $.ajax({type:a,url:n,processData:!1,contentType:!1,data:t,success:function(e){y(e)},error:function(){MLInvoice.errormsg("Request failed")}}),e.preventDefault(),!1}),t.find("a").off("click").on("click",function(e){var t=$(this).attr("href");return $.get(t,y).fail(function(){MLInvoice.errormsg("Request failed")}),e.preventDefault(),!1})}function b(e){e=new String(e);return 8===e.length&&(e=e.substr(0,4)+"-"+e.substr(4,2)+"-"+e.substr(6,2)),moment(e).format(s)}function w(e,t){var a=$(e),e="primary";a.hasClass("btn-secondary")&&(e="secondary"),t?a.removeClass("btn-outline-"+e).addClass("btn-"+e).addClass("text-light"):a.removeClass("btn-"+e).removeClass("text-light").addClass("btn-outline-"+e)}function T(e){e=$(e);return e.hasClass("btn-primary")||e.hasClass("btn-secondary")}return{init:function(){$('input[class~="hasDateRangePicker"]').each(function(){var a=$(this);a.daterangepicker(MLInvoice.getDateRangePickerDefaults()).val(""),a.on("apply.daterangepicker",function(e,t){a.val(t.startDate.format(MLInvoice.getDateFormat())+" - "+t.endDate.format(MLInvoice.getDateFormat())),a.trigger("change")}),a.on("cancel.daterangepicker",function(){a.val("")})}),$("#form").find('input[type="text"],input[type="date"],input[type="hidden"]:not(.select-default-text),input[type="checkbox"],select:not(.dropdownmenu),textarea').on("change",function(){w(".save_button",!0)}),$(window).on("beforeunload",function(e){if(T(".save_button")||T(".row-add-button"))return e.returnValue=p("UnsavedData"),e.returnValue}),$(document).ajaxStart(function(){$("#spinner").removeClass("hidden")}),$(document).ajaxStop(function(){$("#spinner").addClass("hidden")}),$(document).ajaxError(function(e,t){v(t)}),r&&window.setTimeout(e,6e4),$(".cb-select-all").off("click").on("click",function(){var e=$(this).closest("table");e.find(".cb-select-row").prop("checked",$(this).prop("checked")),m(e.closest(".list_container"))}),$("#cover-letter-button").on("click",function(){$("#cover-letter-form").toggleClass("hidden")}),$("#cover-letter-form .close-btn").on("click",function(){$("#cover-letter-form").addClass("hidden")}),$("#add-custom-prices").on("click",function(){$("#no-custom-prices").addClass("hidden"),$("#custom-prices-form").removeClass("hidden")}),$("#custom-prices-form .save-button").on("click",function(){var e=$("#custom-prices-form"),e={company_id:$("#company_id").val(),discount:u(e.find("#discount").val()),multiplier:u(e.find("#multiplier").val()),valid_until:e.find("#valid_until").val()};return $.ajax({url:"json.php?func=put_custom_prices",type:"POST",dataType:"json",data:JSON.stringify(e),contentTypes:"application/json; charset=utf-8",success:function(){h(p("RecordSaved"),2e3),window.location.reload()}}),!1}),$("#custom-prices-form .delete-button").on("click",function(){if(confirm(p("ConfirmDelete"))){var e={company_id:$("#company_id").val()};return $.ajax({url:"json.php?func=delete_custom_prices",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(){h(p("RecordDeleted"),2e3),window.location.reload()}}),!1}}),$(".print-selected-rows .print-selected-item").on("click",function(){var e=$(this).closest(".list_container").find(".cb-select-row:checked").map(function(){return"id[]="+encodeURIComponent(this.value)}).get(),e="invoice.php?template="+encodeURIComponent($(this).data("templateId"))+"&"+e.join("&");return"openwindow"===$(this).data("style")?window.open(e):window.location.href=e,!1}),$(".form-submit").on("click",function(){var e=$(this),t=e.data("confirm");if(t&&!confirm(p(t)))return!1;var a=e.data("form"),n=a?$("#"+a):$("form"),t=e.data("formTarget");void 0!==t&&n.attr("target",t);a=e.data("setField");return void 0!==a&&(t="1",2===(e=a.split("=",2)).length&&(a=e[0],t=e[1]),n.find("[name="+a+"]").val(t)),w(".save_button",!1),n.trigger("submit"),!1}),$("button.popup-close").on("click",function(){return window.close(),!1}),$("[data-form-submit-on-change").on("change",function(){var e=$(this).data("form");return(e?$("#"+e):$("form")).trigger("submit"),!1}),$("[data-form-cancel]").on("click",function(){window.opener?window.close():history.back()}),$(".update-dates").on("click",function(){return $.getJSON("json.php?func=get_invoice_defaults",{id:$("#record_id").val(),invoice_no:$("#invoice_no").val(),invoice_date:$("#invoice_date").val(),base_id:$("#base_id").val(),company_id:$("#company_id").val(),interval_type:$("#interval_type").val()},function(e){$("#invoice_date").val(e.date),$("#due_date").val(e.due_date),$("#next_interval_date").val(e.next_interval_date||""),w(".save_button",!0)}),!1}),$("a.update-invoice-nr").on("click",function(){return $.getJSON("json.php?func=get_invoice_defaults",{id:$("#record_id").val(),invoice_no:$("#invoice_no").val(),invoice_date:$("#invoice_date").val(),base_id:$("#base_id").val(),company_id:$("#company_id").val(),interval_type:$("#interval_type").val()},function(e){$("#invoice_no").val(e.invoice_no),$("#ref_number").val(e.ref_no),w(".save_button",!0)}),!1}),$("[data-save-search]").on("click",function(){var e=window.location.href.split("?");if(void 0===e[1])return MLInvoice.errormsg("Cannot save an empty search"),!1;let t="?"+e[1];return t=t.replace(/([?&]func=)results/,"$1save_search"),t+="&name="+encodeURIComponent($("#search_name").val()),$.getJSON("json.php"+t,function(e){e.errors?MLInvoice.errormsg(e.errors):MLInvoice.infomsg(MLInvoice.translate("SearchSaved"))}),!1}),n=!0},addTranslation:l,addTranslations:function(e){for(var t in e)"string"==typeof e[t]&&l(t,e[t])},setDispatchNotePrintStyle:function(e){t=e},getDispatchNotePrintStyle:function(){return t},setDateRangePickerDefaults:function(e){d=e},getDateRangePickerDefaults:function(){var e=Object.assign({},d);return e.autoApply=!1,e.autoUpdateInput=!1,e.alwaysShowCalendars=!0,e},setOfferStates:function(e){i=e},isOfferStatus:function(e){return-1!==i.indexOf(e)},translate:p,formatCurrency:f,setKeepAlive:function(e){r=e},updateRowSelectedState:m,infomsg:h,errormsg:_,editUnitPrice:function(){return i=this,a=$(i),r=a.parents("tr"),c=a.parents("table").dataTable(),d=a.text(),s=c.fnGetData(r),e=$("<input/>").attr("type","text").attr("value",d).css("width",a.innerWidth()-24+"px").on("keydown",function(e){if(13===e.which)$(this).data("handled",!0),o();else if(27===e.which)$(this).data("handled",!0),n();else if(9===e.which){var t=$("td.editable"),a=t.index(i);return e.shiftKey?0<a&&$(t[a-1]).trigger("click"):t.length>a+1&&$(t[a+1]).trigger("click"),!1}}).on("click",function(){return!1}).on("blur",function(){$(this).data("handled")||o()}),a.empty().addClass("editing").append(e),e.trigger("select").trigger("focus"),!1;function n(){a.text(d),a.removeClass("editing")}function o(){var e=a.find("input");e.css("width",a.innerWidth()-36+"px"),a.append('<i class="icon-spinner animate-spin"></i>');var t=String(e.val());t!==d?(e={company_id:$("#company_id").val(),product_id:s[0],unit_price:u(t)},$.ajax({url:"json.php?func="+(""===t?"delete_custom_price":"put_custom_price"),type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){a.removeClass("editing");e=null!==e.unit_price?f(e.unit_price):c.fnGetData(a.prev().get(0));""===t?(a.text(e),r.removeClass("custom-price")):(a.text(e),r.addClass("custom-price"))},error:function(){a.text(t),a.removeClass("editing")}})):n()}var i,a,r,c,d,s,e},setCurrencyDecimals:function(e){c=e},getDateFormat:function(){return s},setDateFormat:function(e){s=e.toUpperCase()},checkForUpdates:function(t){Cookies.get("updateversion")&&Cookies.get("currentversion")===t?g(JSON.parse(Cookies.get("updateversion"))):$.getJSON("json.php?func=get_update_info",function(e){g(e),Cookies.set("currentversion",t)})},calcRowSum:function(e){var t=e.partial_payment?1:e.pcs,a=e.price,n=e.discount||0,o=e.discount_amount||0,i=e.vat;a*=1-n/100,a-=o;var r=0,n=0,o=0;return 1===Number(e.vat_included)?o=(n=t*a)-(r=n/(1+i/100)):n=(r=t*a)+(o=r*(i/100)),{sum:r,VAT:o,sumVAT:n}},popupDialog:function(e,t,a,n){var o=$("#popup_dlg");return o.find(".modal-body").html('<i class="icon-spinner animate-spin"></i>'),o.find(".modal-title").text(a),o.off("hidden.bs.modal"),null!==t&&o.on("hidden.bs.modal",t),new bootstrap.Modal(o.get(0)).show(),null!==e?$.get(e,y).fail(function(){MLInvoice.errormsg("Dialog contents could not be loaded")}):void 0!==n&&y(n),!0},clearMessages:function(){$("#toasts").html("")},ajaxErrorHandler:v,formatDate:b,addModule:function(e,t){void 0===this[e]&&(a.push(e),this[e]="function"==typeof t?t():t,n&&this[e].init&&this[e].init())},initTableExportButtons:function(e){new $.fn.dataTable.Buttons(e,{buttons:["copy","csv",$.extend(!0,{},{exportOptions:{format:{body:function(e,t,a,n){var o=$(n).data("export");if(void 0!==o)return o;n=$(n).data("sort");return void 0!==n?n:e}}}},{extend:"excelHtml5"}),"pdf"]}).container().appendTo($("#DataTables_Table_0_length"))},highlightButton:w,updateBaseLogo:function(){var t=$("#logo"),a=$("#no_logo"),e=$("#record_id").val();e&&$.get("json.php?func=get_base&id="+e,function(e){e.logo_filename&&e.logo_filesize&&e.logo_filetype&&e.logo_filedata?(t.find("img").attr("src","data:image/"+e.logo_filetype+";base64,"+e.logo_filedata),t.removeClass("hidden"),a.addClass("hidden")):(t.addClass("hidden"),a.removeClass("hidden"))})},createDataTablesTotalFooter:function(e,t){function o(e){return e=parseFloat(String(e).replace(/,/g,"")),isNaN(e)?0:e}var i=e.api();$(t).each(function(e,t){var a=0;i.column(t).nodes().to$().each(function(){a+=o($(this).data("export"))});var n=0;i.column(t,{page:"current"}).nodes().to$().each(function(){n+=o($(this).data("export"))}),n=MLInvoice.formatCurrency(n,2),a=MLInvoice.formatCurrency(a,2),$(i.column(t).footer()).html('<div class="list-footer-summary>'+p("VisiblePage")+"&nbsp;"+n+'</div><br><div class="list-footer-summary">'+p("Total")+"&nbsp;"+a+"</div>")})}}}();$(document).ready(function(){MLInvoice.init()}),MLInvoice.addModule("Form",function(){var s={},m={},i={},l=null,p=null,c=0;function r(){-1<navigator.userAgent.toLowerCase().indexOf("android")||$("textarea.markdown").each(function(){var e=new EasyMDE({element:this,minHeight:"50px",autoDownloadFontAwesome:!1,indentWithTabs:!1,forceSync:!1,spellChecker:!1,status:!1,toolbarTips:!1,toolbar:[{name:"bold",action:EasyMDE.toggleBold,className:"icon-bold",title:"Bold"},{name:"italic",action:EasyMDE.toggleItalic,className:"icon-italic",title:"Italic"},{name:"headingc",action:EasyMDE.toggleHeadingSmaller,className:"icon-header",title:"Heading"},"|",{name:"blockquote",action:EasyMDE.toggleBlockquote,className:"icon-quote-left",title:"Quote"},{name:"unordered-list",action:EasyMDE.toggleUnorderedList,className:"icon-list-bullet",title:"Unordered list"},{name:"ordered-list",action:EasyMDE.toggleOrderedList,className:"icon-list-numbered",title:"Ordered list"},"|",{name:"preview",action:EasyMDE.togglePreview,className:"icon-eye",title:"Preview"},{name:"side-by-side",action:EasyMDE.toggleSideBySide,className:"icon-columns",title:"Side by side"},{name:"fullscreen",action:EasyMDE.toggleFullScreen,className:"icon-resize-full-alt",title:"Full screen"},"|"]});e.codemirror.options.extraKeys.Tab=!1,e.codemirror.options.extraKeys["Shift-Tab"]=!1,$(this).data("mde",e),e.codemirror.on("change",function(){S(),MLInvoice.highlightButton(".save_button",!0)})})}function d(){var e=$("#update_stock_balance");new bootstrap.Modal(e.get(0)).show()}function u(){$.ajax({url:"json.php?func=update_stock_balance",type:"POST",data:{product_id:$("#record_id").val(),stock_balance_change:document.getElementById("stock_balance_change").value.replace(MLInvoice.translate("DecimalSeparator"),"."),stock_balance_change_desc:document.getElementById("stock_balance_change_desc").value},success:function(e){e.missing_fields?alert(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(e=parseFloat(e.new_stock_balance).toFixed(2).replace(".",MLInvoice.translate("DecimalSeparator")),$("#stock_balance").val(e),t(),bootstrap.Modal.getInstance($("#update_stock_balance").get(0)).hide())}})}function t(){$("#stock_balance_change_log  > tbody > tr").slice(1).remove(),$.ajax({url:"json.php?func=get_stock_balance_rows",type:"POST",data:{product_id:$("#record_id").val()},success:function(e){$("#stock_balance_change_log").append(e)}})}function f(){var e=$("#base_id.linked");""==e.val()?$("#base_id_label").text($("#base_id_label").text()):$("#base_id_label").html('<a href="index.php?func=settings&list=base&form=base&id='+e.val()+'">'+$("#base_id_label").text()+"</a>")}function v(){var e=$("#company_id.linked");0!==e.length&&(""===e.val()?$("#company_id_label").text($("#company_id_label").text()):$("#company_id_label").html('<a href="index.php?func=company&list=&form=company&id='+e.val()+'">'+$("#company_id_label").text()+"</a>"))}function h(o){$("#company_id").val(o.businessId).trigger("change"),$("#company_name").val(o.name),$.each(o.addresses,function(e,t){var a,n;1===t.version&&(1===t.type&&($("#street_address").val(t.street),$("#zip_code").val(t.postCode),$("#city").val(t.city),$("#country").val(t.country)),2===t.type&&((a=[]).push(o.name),t.careOf&&a.push("c/o "+t.careOf),t.street&&a.push(t.street),t.postCode&&(n=t.postCode+" "+t.city,a.push(n.trim())),t.country&&a.push(t.country),$("#billing_address").val(a.join("\n"))))}),$.each(o.contactDetails,function(e,t){if(1===parseInt(t.version,10))switch(t.type){case"Matkapuhelin":$("#gsm").val(t.value);break;case"Kotisivun www-osoite":$("#www").val(t.value);break;case"Puhelin":$("#phone").val(t.value);break;case"Faksi":$("#fax").val(t.value)}})}function _(){$(".select-default-text").each(function(){var a=$(this).data("target"),n=$(this).data("sendFormParam"),t=$('<input type="hidden" class="select-default-text"/>').appendTo($(this));t.select2({placeholder:"",ajax:{url:"json.php",dataType:"json",quietMillis:200,data:function(e,t){return{func:"get_selectlist",table:"default_value",q:e,type:$(this).parent().data("type"),pagelen:50,page:t}},results:function(e){return{results:e.records,more:e.moreAvailable}}},dropdownCssClass:"bigdrop",dropdownAutoWidth:!0,escapeMarkup:function(e){return e},width:"element",minimumResultsForSearch:-1}),t.on("change",function(){var e=t.select2("val");e&&(t.select2("val",null),$.ajax({url:"json.php",data:{func:"get_default_value",id:e}}).done(function(e){var t;n?((t=$('<input type="hidden"/>')).attr("name",n),t.attr("value",e.id),$("#"+a).append(t),$("#"+a).submit()):(t=$("#"+a).data("mde"))?t.value(e.content):($("#"+a).val(e.content),$("#"+a).trigger("change"))}).fail(function(e,t){window.alert("Request failed: "+e.status+" - "+t)}))})})}function g(e){var r={_onChangeCompany:y,_onChangeCompanyOffer:a,_onChangeProduct:n,_onChangeCompanyReload:o};$(void 0===e?"body":e).find(".select2").each(function(){var a=$(this);!a.attr("id")||(t=$("label[for="+a.attr("id")+"]")).length&&t.attr("for","s2id_"+t.attr("for"));var n=a.hasClass("tags"),o=a.data("query"),i=a.data("showEmpty"),e=a.data("onChange"),t={placeholder:"",ajax:{url:"json.php?func=get_selectlist&"+o,dataType:"json",quietMillis:200,data:function(e,t){e={q:e,pagelen:50,page:t};return"iform_product_id"!==a[0].id||(t=$("#company_id")).length&&t.val()&&(e.company=t.val()),e},results:function(e,t){var a=[];return n?$(e.records).each(function(){a.push({id:this.text,text:this.text,descriptions:[]})}):a=e.records,i&&1===t&&""===e.filter&&a.unshift({id:"",text:"-"}),{results:a,more:e.moreAvailable}}},initSelection:function(e,t){e=$(e).val();""!==e&&$.ajax("json.php?func=get_selectlist&"+o+"&id="+e,{dataType:"json"}).done(function(e){t(e.records[0])})},formatResult:function(e){var t=e.text;return $(e.descriptions).each(function(){t+='<div class="select-description">'+this+"</div>"}),t},dropdownCssClass:"bigdrop",dropdownAutoWidth:!0,escapeMarkup:function(e){return e},width:"style"};n&&$.extend(t,{tags:!0,tokenSeparators:[","],createSearchChoice:function(e){return{id:$.trim(e),text:$.trim(e)+" (+)"}},initSelection:function(e,t){var a=[],e=e.val();if(!e)return a;$(e.split(",")).each(function(){""!==$.trim(this)&&a.push({id:this,text:this})}),t(a)},formatSelection:function(e){e=(e=e.text).replace(/ \(\+\)$/,"");return $("<div/>").text(e).html()}});t=a.select2(t);e&&"function"==typeof r[e]&&t.on("change",r[e])})}function y(e){var t=void 0===e;$("#invoice_vatless").val("0"),b(""),$.getJSON("json.php?func=get_company",{id:$("#company_id").val()},function(e){e&&(t||(e.default_ref_number&&$("#ref_number").val(e.default_ref_number),e.delivery_terms_id&&$("#delivery_terms_id").val(e.delivery_terms_id),e.delivery_method_id&&$("#delivery_method_id").val(e.delivery_method_id),e.payment_days&&$.getJSON("json.php?func=get_invoice_defaults",{id:$("#record_id").val(),invoice_no:$("#invoice_no").val(),invoice_date:$("#invoice_date").val(),base_id:$("#base_id").val(),company_id:$("#company_id").val(),interval_type:$("#interval_type").val()},function(e){$("#due_date").val(e.due_date)}),$("#delivery_address").val(e.delivery_address||"")),e.info&&b(e.info),e.invoice_default_foreword&&$("#foreword").val(e.invoice_default_foreword),e.invoice_default_afterword&&$("#afterword").val(e.invoice_default_afterword),e.invoice_vatless&&$("#invoice_vatless").val("1"))})}function a(){b(""),$.getJSON("json.php?func=get_company",{id:$("#company_id").val()},function(e){e&&(e.info&&b(e.info),e.offer_default_foreword&&$("#foreword").val(e.offer_default_foreword),e.offer_default_afterword&&$("#afterword").val(e.offer_default_afterword))})}function n(){var d,e;""!==this.value&&(d=this.form.id,e=$("#company_id").val(),$.getJSON("json.php?func=get_product&id="+this.value+"&company_id="+e,function(e){if((l=e)&&e.id){var t=new Event("change");""===e.description&&document.getElementById(d+"_description").value!==(null!==p?p:"")||((c=document.getElementById(d+"_description")).value=e.description,c.dispatchEvent(t)),p=e.description;for(var a=document.getElementById(d+"_type_id"),n=0;n<a.options.length;n++){var o=a.options[n];if(o.value===(null===e.type_id?"":String(e.type_id))){o.selected=!0,a.dispatchEvent(t);break}}var i=(e.custom_price&&null!==e.custom_price.unit_price?e.custom_price:e).unit_price,r=document.getElementById(d+"_price");r.value=e.unit_price?MLInvoice.formatCurrency(i):"",r.dispatchEvent(t),(r=document.getElementById(d+"_discount")).value=e.discount?e.discount.replace(".",","):"",r.dispatchEvent(t),(r=document.getElementById(d+"_discount_amount")).value=e.discount_amount?MLInvoice.formatCurrency(e.discount_amount):"",r.dispatchEvent(t);var c=document.getElementById(d+"_vat"),i=document.getElementById(d+"_vat_included");"0"===$("#invoice_vatless").val()?(r=document.getElementById(d+"_vat"),c.value=e.vat_percent?e.vat_percent.replace(".",","):"",i.checked=!(!e.vat_included||1!==e.vat_included)):(c.value="0",i.checked=!1),c.dispatchEvent(t),i.dispatchEvent(t)}}))}function o(){var e=(e=window.location.href).replace(/[\\?&]company=\d*/,"");e+=0<=e.indexOf("?")?"&":"?",e+="company="+this.value,window.location.href=e}function b(e){e?$('<a class="btn btn-outline-secondary btn-sm info" role="button"></a>').html('<i class="icon-info"></i>').attr("title",e).on("click",function(){MLInvoice.popupDialog(null,null,MLInvoice.translate("Info"),$("<div>").text(e).html().replace(/\n/g,"<br>"))}).appendTo($("#company_id_label")):$("#company_id_label>span.info").remove()}function w(){var e,a=$(".send-buttons");0!==a.length&&(a.html("").addClass("hidden"),""!==(e=String($("#base_id").val()))&&$.getJSON("json.php?func=get_send_api_services",{invoice_id:String($("#record_id").val()),base_id:e},function(e){$.each(e.services,function(e,t){$('<a class="btn btn-secondary dropdown-toggle" href="#" role="button" id="dropdown-button-send-'+e+'" data-bs-toggle="dropdown" aria-expanded="false">').text(t.name+"...").appendTo(a);var n=$('<ul class="dropdown-menu" aria-labelledby="dropdown-button-send-'+e+'">');$.each(t.items,function(e,t){var a=$('<li class="dropdown-item">').text(t.name);a.on("click",function(){!function(e){if(!T())return;void 0===$("#form").data("readOnly")?MLInvoice.Form.saveRecord(e,"",!0):window.location.href=e}("?"+t.href)}),n.append(a)}),a.append(n),a.append(" "),a.removeClass("hidden")})}))}function T(){var e=$("#form");if(void 0!==e.data("checkInvoiceDate")){var t=$("#invoice_date").val();if(t!==moment().format("YYYY-MM-DD")&&!confirm(MLInvoice.translate("InvoiceDateNonCurrent")))return}if(!MLInvoice.isOfferStatus($("#state_id").val())){t=$("#ref_number").val().length;if(0<t&&t<4&&!confirm(MLInvoice.translate("InvoiceRefNumberTooShort")))return;if(void 0!==e.data("checkInvoiceNumber")){e=String($("#invoice_no").val());if((""===e||"0"===e)&&!confirm(MLInvoice.translate("InvoiceNumberNotDefined")))return}}return 1}function I(){var e=$("#attachments-form").data("invoiceId"),r=$("<div/>");c=0,$.getJSON("json.php?func=get_invoice_attachments&parent_id="+e,function(e){var i=0;$.each(e.records,function(e,t){i+=1,t.order_no>c&&(c=t.order_no);var a=$("<div/>").addClass("attachment");$('<a role="button" class="btn btn-outline-primary btn-sm remove-attachment">').html('<i class="icon-minus"></i>').attr("title",MLInvoice.translate("RemoveAttachment")).attr("aria-label",MLInvoice.translate("RemoveAttachment")).on("click",function(){$.getJSON("json.php?func=delete_invoice_attachment&id="+t.id,function(){I()})}).appendTo(a);var n=$("<input>").attr("type","checkbox").data("id",t.id).prop("checked",t.send);n.on("change",function(){$.ajax({url:"json.php?func=put_invoice_attachment",data:{id:$(this).data("id"),send:$(this).prop("checked")?"1":"0"},type:"POST",dataType:"json"})});var o=$("<label/>").addClass("attachment-send");n.appendTo(o),$("<span/>").text(" "+MLInvoice.translate("SendToClient")).appendTo(o),o.appendTo(a);n=$("<input/>").addClass("form-control attachment-name").attr("type","text").data("id",t.id).val(t.name).attr("placeholder",MLInvoice.translate("Description"));n.on("change",function(){$.ajax({url:"json.php?func=put_invoice_attachment",data:{id:$(this).data("id"),name:$(this).val()},type:"POST",dataType:"json"})}),n.appendTo(a);o=$("<div/>").addClass("attachment-fileinfo");$("<a/>").attr("href","attachment.php?type=invoice&id="+t.id).attr("target","_blank").text(t.filename).appendTo(o);n=$("<span/>").text(" ("+t.filesize_readable+")");1048576<t.filesize&&(n.addClass("large-file"),n.attr("title",MLInvoice.translate("LargeFile"))),n.appendTo(o),o.appendTo(a),a.appendTo(r)}),0===i&&r.text(MLInvoice.translate("NoEntries")),$(".attachment-list").empty().append(r),$(".attachment-count").text(i)})}function S(){"invoice"===s.type&&!s.modificationWarningShown&&s.modificationWarning&&(alert(s.modificationWarning),s.modificationWarningShown=!0)}function k(){var e=$("#quick_add_company");new bootstrap.Modal(e.get(0)).show()}function x(){var e={};e.company_name=document.getElementById("quick_name").value,e.company_id=document.getElementById("quick_vat_id").value,e.email=document.getElementById("quick_email").value,e.phone=document.getElementById("quick_phone").value,e.street_address=document.getElementById("quick_street_address").value,e.zip_code=document.getElementById("quick_zip_code").value,e.city=document.getElementById("quick_city").value,e.country=document.getElementById("quick_country").value,$.ajax({url:"json.php?func=put_company",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){e.missing_fields?alert(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(e=e.id,$.getJSON("json.php?func=get_company",{id:e},function(e){var t=e.company_name;e.company_id&&(t+=" ("+e.company_id+")");var a=$("#company_id");a.select2("data",{id:e.id,text:t}),a.trigger("change")}),bootstrap.Modal.getInstance($("#quick_add_company").get(0)).hide())}})}function M(){var e=$("#add_partial_payment");new bootstrap.Modal(e.get(0)).show()}function C(){$.getJSON("json.php?func=add_reminder_fees&id="+$("#record_id").val(),function(e){e.errors?MLInvoice.errormsg(e.errors):MLInvoice.infomsg(MLInvoice.translate("ReminderFeesAdded")),MLInvoice.Form.initRows()})}function L(){var e={};e.invoice_id=$("#record_id").val(),e.description=MLInvoice.translate("PartialPayment"),e.row_date=$("#add_partial_payment_date").val(),e.price=-parseFloat($("#add_partial_payment_amount").val().replace(MLInvoice.translate("DecimalSeparator"),".")),e.pcs=0,e.vat=0,e.vat_included=0,e.order_no=1e5,e.partial_payment=1,$.ajax({url:"json.php?func=put_invoice_row",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){e.missing_fields?alert(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(MLInvoice.Form.initRows(),bootstrap.Modal.getInstance($("#add_partial_payment").get(0)).hide())}})}function E(){w();var e=String($("#base_id").val());""!==e&&$.ajax({url:"json.php?func=get_base",data:{id:e},type:"GET",success:function(a){var e=$("#state_id").val();$.ajax({url:"json.php?func=get_invoice_state",data:{id:e},type:"GET",success:function(e){var t;0!=e.invoice_open&&(e=1==e.invoice_offer?"offer":"invoice",a[e+"_default_foreword"]&&(""!==(t=$("#foreword").val())&&t!==a.invoice_default_foreword&&t!==a.offer_default_foreword||$("#foreword").val(a[e+"_default_foreword"])),a[e+"_default_afterword"]&&(""!==(t=$("#afterword").val())&&t!==a.invoice_default_afterword&&t!==a.offer_default_afterword||$("#afterword").val(a[e+"_default_afterword"])),a.invoice_default_info&&""==$("#info").val()&&$("#info").val(a.invoice_default_info))}})}})}return{initForm:function(e,t,a){m=t,i=a,(s=e).modificationWarningShown=!1,$("#form").find('input[type="text"],[type="date"]:not([name="payment_date"]),input[type="hidden"],input[type="checkbox"]:not([name="archived"]),select:not(.dropdownmenu),textarea').one("change",S),$(".save_button").on("click",function(){return MLInvoice.Form.saveRecord(),!1}),$("#base_id").on("change",E),$("#state_id").on("change",E),$("#company_id.select2").val()&&y(),$(".update-stock-balance").on("click",d),$("#base_id.linked").on("change",f),f($("#base_id.linked")),$("#company_id.linked").on("change",v),v($("#company_id.linked")),$("[data-add-reminder-fees]").on("click",C),$("[data-add-partial-payment]").on("click",M),$("[data-save-partial-payment]").on("click",L),$("[data-quick-add-company]").on("click",k),$("[data-save-company]").on("click",x),$("[data-save-stock-balance-change]").on("click",u);var n,o=this;$("[data-iform-copy-row]").on("click",function(){return o.saveRow($(this).data("iform-copy-row"),!0),!1}),$("[data-iform-save-row]").on("click",function(){return o.saveRow($(this).data("iform-save-row")),!1}),$("[data-iform-delete-row]").on("click",function(){return!0===confirm(MLInvoice.translate("ConfirmDelete"))&&o.deleteRow($(this).data("iform-delete-row")),!1}),$("[data-iform-save-rows]").on("click",function(){return o.modifyRows($(this).data("iform-save-rows")),!1}),$(".modification-indicator .clear").on("click",function(){var e=$(this).closest(".modification-indicator");e.addClass("hidden");e=e.closest("td");e.find('input[type="text"],input[type="date"],input[type="hidden"]:not(.select-default-text),input[type="checkbox"],select:not(.dropdownmenu),textarea').data("modified",0),e.find('input[type="text"],input[type="date"],input[type="hidden"]:not(.select-default-text),textarea').val(""),e.find('input[type="checkbox"]').prop("checked",!1),e.find("select:not(.dropdownmenu)").val(""),e.find("input.select2").select2("val",null)}),0!==(e=$("a.ytj_search_button")).length&&e.on("click",function(){var e,a=(a=$("#company_id").val())||$("#company_name").val();""!==(a=window.prompt(MLInvoice.translate("SearchYTJPrompt"),a))&&null!==a&&(e=a.replace(/FI-?/i,""),$.ajax({url:"https://avoindata.prh.fi/bis/v1",data:{maxResults:1,businessId:e},global:!1}).done(function(e){void 0!==e.results[0]&&h(e.results[0])}).fail(function(e,t){404===e.status?$.ajax({url:"https://avoindata.prh.fi/bis/v1",data:{maxResults:1,name:a},global:!1}).done(function(e){void 0!==e.results[0]&&h(e.results[0])}).fail(function(e,t){404===e.status?window.alert(MLInvoice.translate("NoYTJResultsFound")):window.alert("Request failed: "+e.status+" - "+t)}):window.alert("Request failed: "+e.status+" - "+t)}))}),r(),_(),g(),n=$("#attachments-form").data("invoiceId"),$("#attachments-button").on("click",function(){$(this).attr("aria-expanded","true"===$(this).attr("aria-expanded")?"false":"true"),$("#attachments-form").hasClass("hidden")&&I(),$("#attachments-button .dropdown-open").toggleClass("hidden"),$("#attachments-button .dropdown-close").toggleClass("hidden"),$("#attachments-form").toggleClass("hidden")}),$(".add-attachment").on("click",function(){$.ajax({url:"json.php?func=add_invoice_attachment&id="+$(this).data("id")+"&invoice_id="+n,type:"POST",dataType:"json",success:function(){I()}})}),$("#new-attachment-file").on("change",function(){var e;0<this.files.length&&((e=new FormData).append("filedata",this.files[0]),e.append("invoice_id",n),e.append("order_no",c+5),$.ajax({url:"json.php?func=put_invoice_attachment",type:"POST",dataType:"json",data:e,processData:!1,contentType:!1,success:function(e){e.warnings&&alert(e.warnings),e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):I()}}),$(this).val(null))}),w(),$("[data-print-id]").on("click",function(){var e=$(this),t=e.data("print-id"),a=e.data("func"),e=e.data("print-style");MLInvoice.Form.printInvoice(t,a,e)})},initAddressAutocomplete:function(a){var t,n=document.getElementById(a+"street_address");null!==n&&($(n).attr("placeholder",""),$(n).blur(function(){var e=$(n).val();setTimeout(function(){$(n).val(e)},0)}),t=new google.maps.places.Autocomplete(n,{types:["geocode"]}),google.maps.event.addListener(t,"place_changed",function(){var e=t.getPlace();setTimeout(function(){$("#"+a+"street_address").val(e.name),$.each(e.address_components,function(e,t){0<=$.inArray("postal_code",t.types)?$("#"+a+"zip_code").val(t.long_name).trigger("change"):0<=$.inArray("locality",t.types)||0<=$.inArray("administrative_area_level_3",t.types)?$("#"+a+"city").val(t.long_name).trigger("change"):0<=$.inArray("country",t.types)&&$("#"+a+"country").val(t.long_name).trigger("change")})},0)}))},saveRecord:function(a,n,o){MLInvoice.clearMessages();var i=$("#form"),r=new FormData;$.each(s.fields,function(e,t){var a,n=i.find("[name="+t.name+"]");switch(t.type){case"CHECK":r.append(t.name,n.prop("checked"));break;case"INT":r.append(t.name,n.val().replace(MLInvoice.translate("DecimalSeparator"),"."));break;case"FILE":0<n.get(0).files.length&&r.append(t.name,n.get(0).files[0]);break;case"INTDATE":case"SELECT":case"SEARCHLIST":case"LIST":case"TEXT":case"PASSWD":case"TAGS":r.append(t.name,n.val());break;case"AREA":n.hasClass("markdown")?(a=n.data("mde"),r.append(t.name,void 0!==a?a.value():n.val())):r.append(t.name,n.val())}}),r.append("id",i.find("#record_id").val()),void 0!==o&&r.append("onPrint",o),$.ajax({url:"json.php?func=put_"+s.type,type:"POST",dataType:"json",data:r,processData:!1,contentType:!1,success:function(e){var t;e.warnings&&alert(e.warnings),e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):("invoice"===s.type&&void 0!==o&&o&&($("input#invoice_no").val(e.invoice_no),$("input#ref_number").val(e.ref_number)),$(".deleted-record-msg").remove(),MLInvoice.highlightButton(".save_button",!1),MLInvoice.infomsg(MLInvoice.translate("RecordSaved"),2e3),a&&("openwindow"===n?window.open(a):window.location=a),i.find("#record_id").val()||(i.find("#record_id").val(e.id),a&&"openwindow"!==n||(t=new String(window.location).split("#",1)[0],window.location=t+"&id="+e.id)))}})},initRows:function(d){$(".cb-select-all").prop("checked",!1);var e="";switch(m.type){case"company":e="get_companies";break;case"company_contact":e="get_company_contacts";break;case"invoice_row":e="get_invoice_rows";break;case"send_api_config":e="get_send_api_configs"}var l=s.readOnly,p=s.type,u=m,f=i,v=this;$.getJSON("json.php?func="+e+"&parent_id="+s.id,function(e){var t=$("#itable");$("#itable > tbody > tr[id!=form_row]").remove(),$("#itable > tfoot").remove();var a,n,o,i,r=t.find("tbody");$.each(e.records,function(e,d){var t,a,s=$("<tr/>").addClass("item-row");l||"invoice"!==p||($('<td class="sort-col"><span class="sort-handle"><i class="icon-sort"></i><span class="visually-hidden">'+MLInvoice.translate("Sort")+"</span></span>").appendTo(s),a=MLInvoice.translate("SelectRow"),(t=$("<input/>").addClass("cb-select-row").attr("type","checkbox").attr("title",a).attr("aria-label",a).on("click",function(){MLInvoice.updateRowSelectedState($(this).closest(".list_container"))})).val(d.id),(a=$('<td class="select-row"/>')).append(t),s.append(a)),$.each(u.fields,function(e,t){var a=$("<td/>").addClass(t.style+(d.deleted?" deleted":""));a.data("field",t.name),a.data("th",t.name);var n=d[t.name];switch(t.type){case"LIST":case"SEARCHLIST":var o=t.name+"_text",i="",i=void 0!==d[o]&&null!==d[o]||void 0===f[t.name][n]?d[o]:f[t.name][n];"invoice_row"===u.type&&"product_id"===t.name?null!==n&&(c=$("<a/>").attr("href","?func=settings&list=product&form=product&listid=list_product&id="+d[t.name]).text(i),a.append(c)):a.text(i),a.appendTo(s);break;case"PASSWD_STORED":a.text(""),a.appendTo(s);break;case"INT":void 0!==t.decimals?a.text(n?MLInvoice.formatCurrency(n,t.decimals):" "):a.text(n?String(n).replace(".",MLInvoice.translate("DecimalSeparator")):" "),a.appendTo(s);break;case"INTDATE":a.text(null!==n?MLInvoice.formatDate(n):" "),a.appendTo(s);break;case"CHECK":a.text(MLInvoice.translate(n?"YesButton":"NoButton")),a.appendTo(s);break;case"ROWSUM":var r=MLInvoice.calcRowSum(d),o=MLInvoice.formatCurrency(r.sum),c=MLInvoice.formatCurrency(r.VAT),i=MLInvoice.formatCurrency(r.sumVAT),r=MLInvoice.formatCurrency(r.sumVAT,2),i=MLInvoice.translate("VATLess")+": "+o+" + "+MLInvoice.translate("VATPart")+": "+c+" = "+i,r=$("<span/>").attr("title",i).text(r);a.append(r),a.appendTo(s);break;case"TAGS":r=(r=n?String(n):"").replace(new RegExp(/,/,"g"),", ");a.text(r),a.appendTo(s);break;case"TEXT":case"AREA":a.text(n||""),a.appendTo(s)}}),l||(a=$("<a/>").addClass("btn btn-outline-secondary btn-sm row-edit-button").attr("role","button").attr("href","#").attr("title",MLInvoice.translate("Edit")).html('<i class="icon-pencil"></i>').on("click",function(e){return v.popupEditor(e,MLInvoice.translate("RowModification"),d.id),!1}),$("<td/>").addClass("button").append(a).appendTo(s)),r.append(s)}),"invoice_row"===u.type&&(a=$("<tfoot>").appendTo(t),n=function(e){for(var t=0,a=0,n=0,o=0,i=0,r=0;r<e.length;r++){var c,d,s,l,p,u,f=e[r];f.partial_payment?i+=parseFloat(f.price):(c=f.pcs,d=f.price,p=f.discount||0,u=f.discount_amount||0,s=f.vat,l=f.vat_included,null!==f.product_weight&&(o+=c*parseFloat(f.product_weight)),d*=1-p/100,d-=u,u=p=f=0,1==l?u=(p=c*d)-(f=p/(1+s/100)):p=(f=c*d)+(u=f*(s/100)),t+=f,a+=u,n+=p)}return{totSum:t,totVAT:a,totSumVAT:n,totWeight:o,partialPayments:i}}(e.records),o=$("<tr/>").addClass("summary"),i=$("<td/>").addClass("input modify-controls").attr("colspan","6").attr("rowspan","2"),l||(i.text(MLInvoice.translate("ForSelected")+": "),$("<button/>").attr("id","delete-selected-rows").addClass("btn btn-secondary selected-row-button").text(MLInvoice.translate("Delete")).on("click",function(){return v.deleteSelectedRows(),!1}).appendTo(i),i.append($("<span/>").text(" ")),$("<button/>").attr("id","update-selected-rows").addClass("btn btn-secondary selected-row-button").text(MLInvoice.translate("Modify")).on("click",function(e){return v.multiEditor(e,MLInvoice.translate("ModifySelectedRows")),!1}).appendTo(i)),i.appendTo(o),$("<td/>").addClass("input summary-heading").attr("colspan","7").text(MLInvoice.translate("TotalExcludingVAT")).appendTo(o),$("<td/>").addClass("input currency").text(MLInvoice.formatCurrency(n.totSum)).appendTo(o),$("<td/>").attr("colspan","2").appendTo(o),a.append(o),o=$("<tr/>").addClass("summary"),$("<td/>").addClass("input summary-heading").attr("colspan","7").text(MLInvoice.translate("TotalVAT")).appendTo(o),$("<td/>").addClass("input currency").text(MLInvoice.formatCurrency(n.totVAT)).appendTo(o),$("<td/>").attr("colspan","2").appendTo(o),a.append(o),o=$("<tr/>").addClass("summary"),$("<td/>").addClass("input summary-heading").attr("colspan","13").text(MLInvoice.translate("TotalIncludingVAT")).appendTo(o),$("<td/>").addClass("input currency").text(MLInvoice.formatCurrency(n.totSumVAT)).appendTo(o),$("<td/>").attr("colspan","2").appendTo(o),a.append(o),o=$("<tr/>").addClass("summary"),$("<td/>").addClass("input summary-heading").attr("colspan","13").text(MLInvoice.translate("TotalToPay")).appendTo(o),$("<td/>").addClass("input currency").text(MLInvoice.formatCurrency(n.totSumVAT+n.partialPayments)).appendTo(o),$("<td/>").attr("colspan","2").appendTo(o),a.append(o),0<n.totWeight&&(o=$("<tr/>").addClass("summary"),$("<td/>").addClass("input summary-heading").attr("colspan","13").text(MLInvoice.translate("ProductWeight")).appendTo(o),$("<td/>").addClass("input currency").text(MLInvoice.formatCurrency(n.totWeight,3)).appendTo(o),$("<td/>").attr("colspan","2").appendTo(o),a.append(o))),MLInvoice.updateRowSelectedState();var c=t.find("thead th");t.find("tbody tr:not(.summary)").each(function(){for(var e=$(this).find("td"),t=0;t<e.length;t++)$(e.get(t)).attr("data-th",$(c.get(t)).text().trim()+" ")}),l||"invoice"!==p||Sortable.create($("#itable > tbody").get(0),{direction:"vertical",draggable:"tr.item-row",handle:".sort-col",onEnd:function(){v.updateRowOrder()}}),$("#iform").find('input[type="text"],input[type="date"],input[type="hidden"],input[type="checkbox"]:not(.cb-select-row):not(.cb-select-all),select:not(.dropdownmenu),textarea').on("change",function(){MLInvoice.highlightButton(".row-add-button",!0)}),$("#iform").find('input[type="text"],input[type="date"],input[type="hidden"],input[type="checkbox"],select:not(.dropdownmenu),textarea').one("change",S),$("#iform_popup").find('input[type="text"],input[type="date"],input[type="hidden"]:not(.select-default-text),input[type="checkbox"],select:not(.dropdownmenu),textarea').on("change",function(){$(this).parent().parent().find(".modification-indicator").removeClass("hidden"),$(this).data("modified",1)}),void 0!==d&&d(),u.dispatchByDateButtons&&v.updateDispatchByDateButtons(e.records)})},updateRowOrder:function(){var e={};e.table=m.type,e.order={};var t=1;$(".cb-select-row").each(function(){e.order[this.value]=t,t+=1}),$.ajax({url:"json.php?func=update_row_order",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(){MLInvoice.Form.initRows()}})},saveRow:function(i,e){MLInvoice.clearMessages();var r=$("#"+i),o={},e=void 0!==e&&e?0:r.data("rowId");$.each(m.fields,function(e,t){var a,n=r.find("[name="+i+"_"+t.name+"]");switch(t.type){case"CHECK":o[t.name]=n.prop("checked");break;case"INT":o[t.name]=n.val().replace(MLInvoice.translate("DecimalSeparator"),".");break;case"INTDATE":o[t.name]=n.val();break;case"TAGS":case"SEARCHLIST":case"LIST":case"TEXT":case"PASSWD":case"PASSWD_STORED":o[t.name]=n.val();break;case"AREA":n.hasClass("markdown")?(a=n.data("mde"),o[t.name]=void 0!==a?a.value():n.val()):o[t.name]=n.val()}}),o[m.parentKey]=s.id,e&&(o.id=e);var c=m,t=this;$.ajax({url:"json.php?func=put_"+m.type,type:"POST",dataType:"json",data:JSON.stringify(o),contentType:"application/json; charset=utf-8",success:function(e){e.error?MLInvoice.errormsg(e.error):e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(MLInvoice.infomsg(MLInvoice.translate("RecordSaved"),2e3),MLInvoice.highlightButton(".row-add-button",!1),t.initRows(),r.data("popup")&&bootstrap.Modal.getInstance($("#popup_edit").get(0)).hide(),o.id||(""!==c.onAfterRowAdded&&c.onAfterRowAdded(),$.each(c.fields,function(e,t){var a,n=r.find("[name="+i+"_"+t.name+"]");if(void 0!==t.default&&String(t.default).startsWith("ADD+"))n.val(parseInt(n.val(),10)+parseInt(String(t.default).substr(4)));else if(void 0!==t.default&&"DATE_NOW"===t.default){var o=new Date;n.val(o.toISOString())}else if(c.clearAfterRowAdded)switch(t.type){case"LIST":n.val([]);break;case"SEARCHLIST":n.select2("val","");break;case"CHECK":n.prop("checked",!1);break;case"INT":case"INTDATE":case"TEXT":n.val("");break;case"AREA":n.hasClass("markdown")&&void 0!==(a=n.data("mde"))?a.value(""):n.val("")}})))}})},deleteRow:function(e){var t=$("#"+e).data("rowId");$.ajax({url:"json.php?func=delete_"+m.type+"&id="+t,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:function(){MLInvoice.Form.initRows(),"iform_popup"==e&&bootstrap.Modal.getInstance($("#popup_edit").get(0)).hide()}})},deleteSelectedRows:function(){var e={};e.id=$(".cb-select-row:checked").map(function(){return this.value}).get(),$.ajax({url:"json.php?func=delete_"+m.type,type:"POST",dataType:"json",data:e,success:function(){MLInvoice.Form.initRows()}})},popupEditor:function(e,t,a){S(),$("#iform_popup .modification-indicator").addClass("hidden"),$("#iform_popup input").data("modified","");var n=m;$.getJSON("json.php?func=get_"+m.type+"&id="+a,function(r){var c,e;r.id&&((c=$("#iform_popup")).data("rowId",a),$.each(n.fields,function(e,t){var a,n=c.find("[name=iform_popup_"+t.name+"]");switch(t.type){case"CHECK":n.prop("checked",r[t.name]?1:0);break;case"INT":void 0!==t.decimals?n.val(r[t.name]?MLInvoice.formatCurrency(r[t.name],t.decimals):""):n.val(r[t.name]?String(r[t.name]).replace(".",MLInvoice.translate("DecimalSeparator")):"");break;case"SEARCHLIST":var o={id:r[t.name],text:r[t.name+"_text"]};n.select2("data",o);break;case"PASSWD_STORED":n.val("");break;case"TAGS":var i=[];$(r[t.name].split(",")).each(function(){i.push({id:this,text:this})}),n.select2("data",i);break;case"INTDATE":case"LIST":case"TEXT":n.val(r[t.name]);break;case"AREA":n.hasClass("markdown")&&void 0!==(a=n.data("mde"))?a.value(r[t.name]):n.val(r[t.name])}}),(e=$("#popup_edit")).find(".modal-title").text(t),g(e),e.find(".edit-single-buttons").removeClass("hidden"),e.find(".edit-multi-buttons").addClass("hidden"),new bootstrap.Modal(e.get(0)).show())})},multiEditor:function(e,t){S(),$("#iform_popup .modification-indicator").addClass("hidden"),$("#iform_popup input").data("modified",0),$("#iform_popup select").data("modified",0);var o=$("#iform_popup");$.each(m.fields,function(e,t){var a,n=o.find("[name=iform_popup_"+t.name+"]");switch(t.type){case"CHECK":n.prop("checked",!1);break;case"SEARCHLIST":n.select2("data",{});break;case"TAGS":n.select2("data",[]);break;case"PASSWD_STORED":case"INT":case"INTDATE":case"LIST":case"TEXT":n.val("");break;case"AREA":n.hasClass("markdown")&&void 0!==(a=n.data("mde"))?a.value(""):n.val("")}}),o.find(".modification-indicator").addClass("hidden");var a=$("#popup_edit");a.find(".modal-title").text(t),g(a),a.find(".edit-single-buttons").addClass("hidden"),a.find(".edit-multi-buttons").removeClass("hidden"),new bootstrap.Modal(a.get(0)).show()},modifyRows:function(o){MLInvoice.clearMessages();var i=$("#"+o),r={};$.each(m.fields,function(e,t){var a,n=i.find("[name="+o+"_"+t.name+"]");if(n.data("modified"))switch(t.type){case"CHECK":r[t.name]=n.prop("checked");break;case"INT":r[t.name]=n.val().replace(MLInvoice.translate("DecimalSeparator"),".");break;case"SEARCHLIST":r[t.name]=n.select2("data");break;case"INTDATE":case"LIST":case"TEXT":r[t.name]=n.val();break;case"AREA":n.hasClass("markdown")?(a=n.data("mde"),r[t.name]=void 0!==a?a.value():n.val()):r[t.name]=n.val()}});var e={};e.table=m.type,e.ids=$("#iform .cb-select-row:checked").map(function(){return this.value}).get(),e.changes=r,$.ajax({url:"json.php?func=update_multiple",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(bootstrap.Modal.getInstance($("#popup_edit").get(0)).hide(),MLInvoice.Form.initRows())}})},getSelectedProductDefaults:function(e){if(null!==l){document.getElementById(e+"_description").value=l.description,p=l.description;for(var t=document.getElementById(e+"_type_id"),a=0;a<t.options.length;a++){var n=t.options[a];if(n.value===l.type_id){n.selected=!0;break}}document.getElementById(e+"_price").value=l.unit_price.replace(".",","),document.getElementById(e+"_discount").value=l.discount.replace(".",","),document.getElementById(e+"_vat").value=l.vat_percent.replace(".",","),document.getElementById(e+"_vat_included").checked=1===l.vat_included}},updateStockBalanceLog:t,printInvoice:function(e,t,a,n){if(T()){t="invoice.php?id="+$("#record_id").val()+"&template="+e+"&func="+t;return void 0!==n&&(t+="&date="+n),void 0===$("#form").data("readOnly")?MLInvoice.Form.saveRecord(t,a,!0):"openwindow"===a?window.open(t):window.location.href=t,!1}},updateDispatchByDateButtons:function(e){if("none"!==MLInvoice.getDispatchNotePrintStyle()&&!MLInvoice.isOfferStatus($("#state_id").val())){var t=$("#dispatch_date_buttons");t.empty();var a=[];$.each(e,function(e,t){return!(!t.reminder_row&&!t.partial_payment)||void(-1===a.indexOf(t.row_date)&&a.push(t.row_date))}),a.sort();function n(){c.printInvoice(2,"start_page",MLInvoice.getDispatchNotePrintStyle(),$(this).data("date"))}var o,i,r,c=this;for(o in a)a.hasOwnProperty(o)&&(i=a[o],(r=$('<a class="btn btn-outline-secondary" role="button">').text(MLInvoice.translate("SettingDispatchNotes")+" "+MLInvoice.formatDate(i))).data("date",i),r.on("click",n),t.append(r),t.append(" "))}},setupSelect2:g,setupDefaultTextSelection:_,setupMarkdownEditor:r}}),MLInvoice.addModule("Search",function(){let n=0;function t(){return o(),!1}function o(){let e=document.getElementById("template_group"),t=e.content.cloneNode(!0),a=t.querySelector(".group");return a.dataset.group=++n,a.querySelector(".operator").name="s_op"+n,document.querySelector("#search_groups").appendChild(t),d(),a}function a(){return this.closest(".group").remove(),d(),!1}function i(){var e=this.closest(".group");return this.closest(".field").remove(),u(e),!1}function r(){let e=$(this),t=e.closest(".group");var a=e.val();return c(t.get(0),a,"eq"),e.val(""),!1}function c(e,t,a){var n=e.dataset.group,o=$(e).find(".fields"),i=e.querySelectorAll("input").length+e.querySelectorAll("select").length+1;let r=MLInvoice.Search.getFormConfig().fields[t];var c=$('<div class="mb-2 field">').appendTo(o),o=$('<div class="mb-2 field-contents">').appendTo(c),d="field-"+n+"-"+i;$('<label class="form-label" for="'+d+'">').text(r.label).appendTo(o);let s=null,l,p={eq:{label:MLInvoice.translate("SearchEqual")},ne:{label:MLInvoice.translate("SearchNotEqual")}};switch("INT"!==r.type&&"INTDATE"!==r.type||(p.lt={label:"<",title:MLInvoice.translate("SearchLessThan")},p.lte={label:"<=",title:MLInvoice.translate("SearchLessThanOrEqual")},p.gt={label:">",title:MLInvoice.translate("SearchGreaterThan")},p.gte={label:">=",title:MLInvoice.translate("SearchGreaterThanOrEqual")}),r.type){case"TEXT":case"AREA":case"INT":s=$('<input type="text" class="form-control medium">');break;case"INTDATE":s=$('<input type="date" class="form-control date">');break;case"SEARCHLIST":s=$('<input type="text" class="select2-container select2" id="'+d+'" value="" data-show-empty="1">').data("query",r.listquery);break;case"SELECT":case"LIST":s=$('<select class="form-control medium">'),$("<option>").attr("value","").text("-").appendTo(s),Object.getOwnPropertyNames(r.options).forEach(function(e){$("<option>").attr("value",e).text(r.options[e]).appendTo(s)})}return null!==s&&($('<input type="hidden">').attr("name","s_type"+n+"[]").val(t).appendTo(o),i=$('<div class="row">').appendTo(o),t=$('<div class="col-auto">').appendTo(i),l=$('<select class="form-select medium">').attr("name","s_cmp"+n+"[]").appendTo(t),Object.getOwnPropertyNames(p).forEach(function(e){let t=$("<option>").attr("value",e).text(p[e].label).appendTo(l);void 0!==p[e].title&&t.attr("title",p[e].title),e===a&&t.attr("selected","selected")}),s.attr("name","s_field"+n+"[]"),i=$('<div class="col">').appendTo(i),s.appendTo(i),$deleteContainer=$('<div class="buttons">').appendTo(c),$('<a role="button" class="btn btn-outline-primary btn-sm delete-field">').html('<i class="icon-minus"></i>').attr("title",MLInvoice.translate("DelRow")).attr("aria-label",MLInvoice.translate("DelRow")).appendTo($deleteContainer),MLInvoice.Form.setupSelect2(o)),u(e),s.get(0)}function u(e){e.querySelector(".field-operator").classList.toggle("hidden",e.querySelectorAll(".field").length<2)}function d(){document.querySelector(".group-operator").classList.toggle("hidden",document.querySelectorAll(".group").length<2)}return{initSearchForm:function(n,e){this.formConfig=n,$("#search_form").on("change",".add-search-field",r),$("#search_form").on("click","#add_group",t),$("#search_form").on("click",".delete-group",a),$("#search_form").on("click",".delete-field",i),0===e.length?o():e.forEach(function(e){let a=o();a.querySelector(".field-operator .operator").value=e.operator,e.fields.forEach(function(e){let t=c(a,e.name,e.comparison);"SEARCHLIST"===n.fields[e.name].type?$(t).select2("val",e.value):t.value=e.value})})},getFormConfig:function(){return this.formConfig}}});
//# sourceMappingURL=mlinvoice.min.js.map