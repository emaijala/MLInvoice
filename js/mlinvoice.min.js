/*! mlinvoice 2019-08-24 */

var MLInvoice=function MLInvoice(){var _modules=[],_initDone=!1,_translations={},_dispatchNotePrintStyle="none",_offerStatuses=[],_keepAliveEnabled=!0,_currencyDecimals=2;function addTranslation(e,t){_translations[e]=t}function addTranslations(e){for(var t in e)"string"==typeof e[t]&&addTranslation(t,e[t])}function addModule(e,t){void 0===this[e]&&(_modules.push(e),this[e]="function"==typeof t?t():t,_initDone&&this[e].init&&this[e].init())}function translate(e,t,a){var n=_translations[e]||e;return n===e&&void 0!==a&&(n=a),"object"==typeof t&&$.each(t,function(e,t){n=n.replace(new RegExp(e,"g"),t)}),n}function setDispatchNotePrintStyle(e){_dispatchNotePrintStyle=e}function getDispatchNotePrintStyle(){return _dispatchNotePrintStyle}function setOfferStatuses(e){_offerStatuses=e}function isOfferStatus(e){return-1!==_offerStatuses.indexOf(e)}function parseDate(e,t){if(!e)return null;var a=void 0===t?"":t;return e.substr(6,4)+a+e.substr(3,2)+a+e.substr(0,2)}function _parseFloat(e){return new String(e).replace(",",".")}function formatCurrency(e,t){var a=void 0===t?_currencyDecimals:t,n=translate("DecimalSeparator"),i=translate("ThousandSeparator",[],""),o=parseFloat(e).toFixed(a).replace(".",n);if(i){for(var r=o.split(n),s=new RegExp("(\\d+)(\\d{3})"+n+"?");s.test(r[0]);)r[0]=r[0].replace(s,"$1"+i+"$2");o=r[0],1<r.length&&(o+=n+r[1])}return o}function _keepAlive(){$.getJSON("json.php?func=noop").done(function(){window.setTimeout(_keepAlive,6e4)})}function setKeepAlive(e){_keepAliveEnabled=e}function setCurrencyDecimals(e){_currencyDecimals=e}function ajaxErrorHandler(e){return $("#spinner").addClass("hidden"),409==e.status?errormsg(jQuery.parseJSON(e.responseText).warnings):errormsg("Error trying to access the server: "+e.status+" - "+e.statusText),!1}function _setupSelectAll(){$(".cb-select-all").click(function(){var e=$(this).closest("table");e.find(".cb-select-row").prop("checked",$(this).prop("checked")),updateRowSelectedState(e.closest(".list_container"))})}function _setupCoverLetterForm(){$("#cover-letter-button").click(function(){$("#cover-letter-form").toggleClass("hidden")}),$("#cover-letter-form .close-btn").click(function(){$("#cover-letter-form").addClass("hidden")})}function _setupCustomPricesForm(){$("#add-custom-prices").click(function(){$("#no-custom-prices").addClass("hidden"),$("#custom-prices-form").removeClass("hidden")}),$("#custom-prices-form .save-button").click(function(){var e=$("#custom-prices-form"),t={company_id:$("#company_id").val(),discount:_parseFloat(e.find("#discount").val()),multiplier:_parseFloat(e.find("#multiplier").val()),valid_until:parseDate(e.find("#valid_until").val())};return $.ajax({url:"json.php?func=put_custom_prices",type:"POST",dataType:"json",data:JSON.stringify(t),contentTypes:"application/json; charset=utf-8",success:function(){infomsg(translate("RecordSaved"),2e3),window.location.reload()}}),!1}),$("#custom-prices-form .delete-button").click(function(){if(confirm(translate("ConfirmDelete"))){var e={company_id:$("#company_id").val()};return $.ajax({url:"json.php?func=delete_custom_prices",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(){infomsg(translate("RecordDeleted"),2e3),window.location.reload()}}),!1}})}function editUnitPrice(){return _editUnitPrice(this)}function _editUnitPrice(n){var i=$(n),o=i.parents("tr"),r=i.parents("table").dataTable(),s=i.text(),c=r.fnGetData(o),d=function(){i.text(s),i.removeClass("editing")},l=function(){var e=i.find("input");e.css("width",i.innerWidth()-36),i.append('<img src="images/spinner.gif" alt="">');var a=String(e.val());if(a!==s){var t={company_id:$("#company_id").val(),product_id:c[0],unit_price:_parseFloat(a)};$.ajax({url:"json.php?func="+(""===a?"delete_custom_price":"put_custom_price"),type:"POST",dataType:"json",data:JSON.stringify(t),contentType:"application/json; charset=utf-8",success:function(e){i.removeClass("editing");var t=null!==e.unit_price?formatCurrency(e.unit_price):r.fnGetData(i.prev().get(0));""===a?(i.text(t),o.removeClass("custom-price")):(i.text(t),o.addClass("custom-price"))},error:function(){i.text(a),i.removeClass("editing")}})}else d()},e=$("<input/>").attr("type","text").attr("value",s).css("width",i.innerWidth()-12).keydown(function(e){if(13===e.which)$(this).data("handled",!0),l();else if(27===e.which)$(this).data("handled",!0),d();else if(9===e.which){var t=$("td.editable"),a=t.index(n);return e.shiftKey?0<a&&t[a-1].click():t.length>a+1&&t[a+1].click(),!1}}).click(function(){return!1}).blur(function(){$(this).data("handled")||l()});return i.empty().addClass("editing").append(e),e.select().focus(),!1}function updateRowSelectedState(e){var t=void 0===e?$("body"):$(e);0===t.find(".cb-select-row:checked").length?(t.find(".selected-row-button").attr("disabled","disabled"),t.find(".selected-row-button").addClass("ui-state-disabled")):(t.find(".selected-row-button").removeAttr("disabled"),t.find(".selected-row-button").removeClass("ui-state-disabled"))}function infomsg(e,t){$.floatingMessage("<span>"+e+"</span>",{position:"top-right",className:"ui-widget ui-state-highlight",show:"show",hide:"fade",stuffEaseTime:200,moveEaseTime:0,time:void 0!==t?t:1e4})}function errormsg(e,t){$.floatingMessage("<span>"+e+"</span>",{position:"top-right",className:"ui-widget ui-state-error",show:"show",hide:"fade",stuffEaseTime:200,moveEaseTime:0,time:void 0!==t?t:1e4})}function clearMessages(){$(".ui-floating-message").trigger("destroy")}function checkForUpdates(e,t){$.cookie("updateversion")&&$.cookie("currentversion")===t?_updateVersionMessage($.parseJSON($.cookie("updateversion")),t):$.getJSON(e+"?callback=?",function(e){_updateVersionMessage(e,t),$.cookie("currentversion",t)})}function _compareVersionNumber(e,t){for(var a=e.split("."),n=t.split(".");a.length<n.length;)a.push(0);for(;n.length<a.length;)n.push(0);for(var i=0;i<a.length;i++)if(a[i]!==n[i])return parseInt(a[i])>parseInt(n[i])?1:-1;return 0}function _updateVersionMessage(e,t){var a=_compareVersionNumber(e.version,t);if(0<a){var n=translate("UpdateAvailableTitle",{"{version}":e.version,"{date}":e.date}),i=$("<span/>").attr("title",n).text(translate("UpdateAvailable")+" ");$("<br/>").appendTo(i),$("<a/>").attr("href",e.url).text(translate("UpdateInformation")).appendTo(i),$("<br/>").appendTo(i),$("<a/>").attr("href","index.php?func=system&operation=update").text(translate("UpdateNow")).appendTo(i),i.appendTo("#version")}else a<0&&$("<span/>").text(translate("PrereleaseVersion")).appendTo("#version");$.cookie("updateversion",JSON.stringify(e),{expires:1})}function calcRowSum(e){var t=e.partial_payment?1:e.pcs,a=e.price,n=e.discount||0,i=e.discount_amount||0,o=e.vat;a*=1-n/100,a-=i;var r=0,s=0,c=0;return 1===Number(e.vat_included)?c=(s=t*a)-(r=s/(1+o/100)):s=(r=t*a)+(c=r*(o/100)),{sum:r,VAT:c,sumVAT:s}}function popupDialog(url,on_close,dialog_title,event,width,height){var buttons={};return buttons[translate("Close")]=function(){$("#popup_dlg").dialog("close")},$("#popup_dlg").find("#popup_dlg_iframe").html(""),$("#popup_dlg").dialog({modal:!0,width:width,height:height,resizable:!0,buttons:buttons,title:dialog_title,close:function onPopupClose(){eval(on_close)}}).find("#popup_dlg_iframe").attr("src",url),!0}function _initUI(){$("input.hasCalendar").each(function(){var e={};$(this).data("noFuture")&&(e.maxDate=0),$(this).datepicker(e)}),$("input.date").each(function(){$(this).data("noFuture")&&$(this).change(function(){var e=$(this).val();10===e.length&&(new Date(parseDate(e,"-"))>new Date&&errormsg(translate("FutureDateEntered")))})}),$("#maintabs ul li").hover(function(){$(this).addClass("ui-state-hover")},function(){$(this).removeClass("ui-state-hover")}),$("#admin_form").find('input[type="text"],input[type="hidden"]:not(.select-default-text),input[type="checkbox"],select:not(.dropdownmenu),textarea').change(function(){$(".save_button").addClass("ui-state-highlight")}),$(window).bind("beforeunload",function(e){if($(".save_button").hasClass("ui-state-highlight")||$(".row-add-button").hasClass("ui-state-highlight"))return e.returnValue=translate("UnsavedData"),e.returnValue}),$(document).ajaxStart(function(){$("#spinner").removeClass("hidden")}),$(document).ajaxStop(function(){$("#spinner").addClass("hidden")}),$(document).ajaxError(function(e,t){ajaxErrorHandler(t)})}function _setupListMultiSelect(){$(".print-selected-rows .print-selected-item").click(function(){var e=$(this).closest(".list_container").find(".cb-select-row:checked").map(function(){return"id[]="+encodeURIComponent(this.value)}).get(),t="invoice.php?template="+encodeURIComponent($(this).data("templateId"))+"&"+e.join("&");return"openwindow"===$(this).data("style")?window.open(t):window.location.href=t,!1})}function init(){_initUI(),_keepAliveEnabled&&window.setTimeout(_keepAlive,6e4),$(".dropdownmenu").menu({}).find("li:first").addClass("formbuttonlink ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only"),_setupSelectAll(),_setupCoverLetterForm(),_setupCustomPricesForm(),_setupListMultiSelect(),_setupFormButtons(),_initDone=!0}function _setupFormButtons(){$("a.form-submit").click(function(){var e=$(this),t=e.data("confirm");if(t&&!confirm(translate(t)))return!1;var a=e.data("form"),n=a?$("#"+a):$("form"),i=e.data("formTarget");void 0!==i&&n.attr("target",i);var o=e.data("setField");if(void 0!==o){var r="1",s=o.split("=",2);2===s.length&&(o=s[0],r=s[1]),n.find("[name="+o+"]").val(r)}return $(".save_button").removeClass("ui-state-highlight"),n.submit(),!1}),$("a.popup-close").click(function(){return window.close(),!1}),$("a.update-dates").click(function(){return $.getJSON("json.php?func=get_invoice_defaults",{id:$("#record_id").val(),invoice_no:$("#invoice_no").val(),invoice_date:$("#invoice_date").val(),base_id:$("#base_id").val(),company_id:$("#company_id").val(),interval_type:$("#interval_type").val()},function(e){$("#invoice_date").val(e.date),$("#due_date").val(e.due_date),$("#next_interval_date").val(e.next_interval_date),$(".save_button").addClass("ui-state-highlight")}),!1}),$("a.update-invoice-nr").click(function(){return $.getJSON("json.php?func=get_invoice_defaults",{id:$("#record_id").val(),invoice_no:$("#invoice_no").val(),invoice_date:$("#invoice_date").val(),base_id:$("#base_id").val(),company_id:$("#company_id").val(),interval_type:$("#interval_type").val()},function(e){$("#invoice_no").val(e.invoice_no),$("#ref_number").val(e.ref_no),$(".save_button").addClass("ui-state-highlight")}),!1})}function formatDate(e){var t=new String(e);return 8===t.length?t.substr(6,2)+"."+t.substr(4,2)+"."+t.substr(0,4):""}function initTableExportButtons(e){new $.fn.dataTable.Buttons(e,{buttons:["copy","csv",$.extend(!0,{},{exportOptions:{format:{body:function(e,t,a,n){var i=$(n).data("export");if(void 0!==i)return i;var o=$(n).data("sort");return void 0!==o?o:e}}}},{extend:"excelHtml5"}),"pdf"]}).container().appendTo($(".fg-toolbar",e.table().container()))}return{init:init,addTranslation:addTranslation,addTranslations:addTranslations,setDispatchNotePrintStyle:setDispatchNotePrintStyle,getDispatchNotePrintStyle:getDispatchNotePrintStyle,setOfferStatuses:setOfferStatuses,isOfferStatus:isOfferStatus,translate:translate,formatCurrency:formatCurrency,setKeepAlive:setKeepAlive,updateRowSelectedState:updateRowSelectedState,infomsg:infomsg,errormsg:errormsg,editUnitPrice:editUnitPrice,setCurrencyDecimals:setCurrencyDecimals,checkForUpdates:checkForUpdates,calcRowSum:calcRowSum,popupDialog:popupDialog,clearMessages:clearMessages,ajaxErrorHandler:ajaxErrorHandler,parseDate:parseDate,formatDate:formatDate,addModule:addModule,initTableExportButtons:initTableExportButtons}}();MLInvoice.addModule("Form",function(){var u={},p={},o={},r=null,s=null,l=0;function c(){-1<navigator.userAgent.toLowerCase().indexOf("android")||$("textarea.markdown").each(function(){var e=new EasyMDE({element:this,minHeight:"50px",autoDownloadFontAwesome:!1,indentWithTabs:!1,forceSync:!1,spellChecker:!1,status:!1,toolbarTips:!1,toolbar:["bold","italic",{name:"headingc",action:EasyMDE.toggleHeadingSmaller,className:"fa fa-heading",title:"Heading"},"|","quote","unordered-list","ordered-list","|","preview","side-by-side","fullscreen","|"]});e.codemirror.options.extraKeys.Tab=!1,e.codemirror.options.extraKeys["Shift-Tab"]=!1,$(this).data("mde",e),e.codemirror.on("change",function(){S(),$(".save_button").addClass("ui-state-highlight")})})}function d(){var e={};e[MLInvoice.translate("Save")]=function(){$.ajax({url:"json.php?func=update_stock_balance",type:"POST",data:{product_id:$("#record_id").val(),stock_balance_change:document.getElementById("stock_balance_change").value.replace(MLInvoice.translate("DecimalSeparator"),"."),stock_balance_change_desc:document.getElementById("stock_balance_change_desc").value},success:function(e){if(e.missing_fields)alert(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields);else{var t=parseFloat(e.new_stock_balance).toFixed(2).replace(".",MLInvoice.translate("DecimalSeparator"));$("#stock_balance").val(t),a(),$("#update_stock_balance").dialog("close")}}})},e[MLInvoice.translate("Close")]=function(){$("#update_stock_balance").dialog("close")},$("#update_stock_balance").dialog({modal:!0,width:400,height:240,resizable:!1,zIndex:900,buttons:e,title:MLInvoice.translate("UpdateStockBalance")})}function a(){$("#stock_balance_change_log  > tbody > tr").slice(1).remove(),$.ajax({url:"json.php?func=get_stock_balance_rows",type:"POST",data:{product_id:$("#record_id").val()},success:function(e){$("#stock_balance_change_log").append(e)}})}function f(){var e=$("#base_id.linked");""==e.val()?$("#base_id_label").text($("#base_id_label").text()):$("#base_id_label").html('<a href="index.php?func=settings&list=base&form=base&id='+e.val()+'">'+$("#base_id_label").text()+"</a>")}function v(){var e=$("#company_id.linked");0!==e.length&&(""===e.val()?$("#company_id_label").text($("#company_id_label").text()):$("#company_id_label").html('<a href="index.php?func=company&list=&form=company&id='+e.val()+'">'+$("#company_id_label").text()+"</a>"))}function m(i){$("#company_id").val(i.businessId).change(),$("#company_name").val(i.name),$.each(i.addresses,function(e,t){if(1===t.version&&(1===t.type&&($("#street_address").val(t.street),$("#zip_code").val(t.postCode),$("#city").val(t.city),$("#country").val(t.country)),2===t.type)){var a=[];if(a.push(i.name),t.careOf&&a.push("c/o "+t.careOf),t.street&&a.push(t.street),t.postCode){var n=t.postCode+" "+t.city;a.push(n.trim())}t.country&&a.push(t.country),$("#billing_address").val(a.join("\n"))}}),$.each(i.contactDetails,function(e,t){if(1===parseInt(t.version,10))switch(t.type){case"Matkapuhelin":$("#gsm").val(t.value);break;case"Kotisivun www-osoite":$("#www").val(t.value);break;case"Puhelin":$("#phone").val(t.value);break;case"Faksi":$("#fax").val(t.value)}})}function _(){$(".select-default-text").each(function(){var n=$(this).data("target"),i=$(this).data("sendFormParam"),t=$('<input type="hidden" class="select-default-text"/>').appendTo($(this));t.select2({placeholder:"",ajax:{url:"json.php",dataType:"json",quietMillis:200,data:function(e,t){return{func:"get_selectlist",table:"default_value",q:e,type:$(this).parent().data("type"),pagelen:50,page:t}},results:function(e){return{results:e.records,more:e.moreAvailable}}},dropdownCssClass:"bigdrop",dropdownAutoWidth:!0,escapeMarkup:function(e){return e},width:"element",minimumResultsForSearch:-1}),t.on("change",function(){var e=t.select2("val");e&&(t.select2("val",null),$.ajax({url:"json.php",data:{func:"get_default_value",id:e}}).done(function(e){if(i){var t=$('<input type="hidden"/>');t.attr("name",i),t.attr("value",e.id),$("#"+n).append(t),$("#"+n).submit()}else{var a=$("#"+n).data("mde");a?a.value(e.content):($("#"+n).val(e.content),$("#"+n).change())}}).fail(function(e,t){window.alert("Request failed: "+e.status+" - "+t)}))})})}function h(e){var s={_onChangeCompany:g,_onChangeCompanyOffer:t,_onChangeProduct:n,_onChangeCompanyReload:i};$(void 0===e?"body":e).find(".select2").each(function(){var i=$(this),n=i.hasClass("tags"),o=i.data("query"),r=i.data("showEmpty"),e=i.data("onChange"),t={placeholder:"",ajax:{url:"json.php?func=get_selectlist&"+o,dataType:"json",quietMillis:200,data:function(e,t){var a={q:e,pagelen:50,page:t};if("iform_product_id"===i[0].id){var n=$("#company_id");n.length&&n.val()&&(a.company=n.val())}return a},results:function(e,t){var a=[];return n?$(e.records).each(function(){a.push({id:this.text,text:this.text,descriptions:[]})}):a=e.records,r&&1===t&&""===e.filter&&a.unshift({id:"",text:"-"}),{results:a,more:e.moreAvailable}}},initSelection:function(e,t){var a=$(e).val();""!==a&&$.ajax("json.php?func=get_selectlist&"+o+"&id="+a,{dataType:"json"}).done(function(e){t(e.records[0])})},formatResult:function(e){var t=e.text;return $(e.descriptions).each(function(){t+='<div class="select-description">'+this+"</div>"}),t},dropdownCssClass:"bigdrop",dropdownAutoWidth:!0,escapeMarkup:function(e){return e},width:"element"};n&&$.extend(t,{tags:!0,tokenSeparators:[","],createSearchChoice:function(e){return{id:$.trim(e),text:$.trim(e)+" (+)"}},initSelection:function(e,t){var a=[],n=e.val();if(!n)return a;$(n.split(",")).each(function(){""!==$.trim(this)&&a.push({id:this,text:this})}),t(a)},formatSelection:function(e){var t=e.text;return t=t.replace(/ \(\+\)$/,""),$("<div/>").text(t).html()}});var a=i.select2(t);e&&"function"==typeof s[e]&&a.change(s[e])})}function g(e){var t=void 0===e;$("#invoice_vatless").val("0"),y(""),$.getJSON("json.php?func=get_company",{id:$("#company_id").val()},function(e){e&&(t||(e.default_ref_number&&$("#ref_number").val(e.default_ref_number),e.delivery_terms_id&&$("#delivery_terms_id").val(e.delivery_terms_id),e.delivery_method_id&&$("#delivery_method_id").val(e.delivery_method_id),e.payment_days&&$.getJSON("json.php?func=get_invoice_defaults",{id:$("#record_id").val(),invoice_no:$("#invoice_no").val(),invoice_date:$("#invoice_date").val(),base_id:$("#base_id").val(),company_id:$("#company_id").val(),interval_type:$("#interval_type").val()},function(e){$("#due_date").val(e.due_date)}),$("#delivery_address").val(e.delivery_address?e.delivery_address:"")),e.info&&y(e.info),e.invoice_default_foreword&&$("#foreword").val(e.invoice_default_foreword),e.invoice_default_afterword&&$("#afterword").val(e.invoice_default_afterword),e.invoice_vatless&&$("#invoice_vatless").val("1"))})}function t(){y(""),$.getJSON("json.php?func=get_company",{id:$("#company_id").val()},function(e){e&&(e.info&&y(e.info),e.offer_default_foreword&&$("#foreword").val(e.offer_default_foreword),e.offer_default_afterword&&$("#afterword").val(e.offer_default_afterword))})}function n(){if(""!==this.value){var o=this.form.id,e=$("#company_id").val();$.getJSON("json.php?func=get_product&id="+this.value+"&company_id="+e,function(e){if((r=e)&&e.id){""===e.description&&document.getElementById(o+"_description").value!==(null!==s?s:"")||(document.getElementById(o+"_description").value=e.description),s=e.description;for(var t=document.getElementById(o+"_type_id"),a=0;a<t.options.length;a++){var n=t.options[a];if(n.value===(null===e.type_id?"":String(e.type_id))){n.selected=!0;break}}var i=e.custom_price&&null!==e.custom_price.unit_price?e.custom_price.unit_price:e.unit_price;document.getElementById(o+"_price").value=e.unit_price?MLInvoice.formatCurrency(i):"",document.getElementById(o+"_discount").value=e.discount?e.discount.replace(".",","):"",document.getElementById(o+"_discount_amount").value=e.discount_amount?MLInvoice.formatCurrency(e.discount_amount):"","0"===$("#invoice_vatless").val()?(document.getElementById(o+"_vat").value=e.vat_percent?e.vat_percent.replace(".",","):"",document.getElementById(o+"_vat_included").checked=!(!e.vat_included||1!==e.vat_included)):(document.getElementById(o+"_vat").value="0",document.getElementById(o+"_vat_included").checked=!1)}})}}function i(){var e=window.location.href;e=e.replace(/[\\?&]company=\d*/,""),e+=0<=e.indexOf("?")?"&":"?",e+="company="+this.value,window.location.href=e}function y(e){e?$("<span/>").addClass("info ui-state-highlight ui-corner-all").attr("title",e).text(" ").click(function(){alert(e)}).appendTo($("#company_id_label")):$("#company_id_label>span.info").remove()}function b(){var o=$(".send-buttons");if(0!==o.length){o.html("");var e=String($("#base_id").val());""!==e&&$.getJSON("json.php?func=get_send_api_services",{invoice_id:String($("#record_id").val()),base_id:e},function(e){$.each(e.services,function(e,t){var a=$('<ul class="dropdownmenu"/>'),n=$("<li/>");n.text(t.name+"..."),a.append(n);var i=$("<ul/>");$.each(t.items,function(e,t){var a=$("<li/>");a.click(function(){!function(e){if(!w())return;void 0===$("#admin_form").data("readOnly")?MLInvoice.Form.saveRecord(e,"",!0):window.location.href=e}("?"+t.href)});var n=$("<div>");n.text(t.name),a.append(n),i.append(a)}),n.append(i),o.append(a),o.append(" ")}),$(".send-buttons .dropdownmenu").each(function(){$(this).menu({}).find("li:first").addClass("formbuttonlink ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only")})})}}function w(){var e=$("#admin_form");if(void 0!==e.data("checkInvoiceDate")){var t=new Date,a=$("#invoice_date").val().split(".");if((parseInt(a[0],10)!==t.getDate()||parseInt(a[1],10)!==t.getMonth()+1||parseInt(a[2],10)!==t.getYear()+1900)&&!confirm(MLInvoice.translate("InvoiceDateNonCurrent")))return!1}if(!MLInvoice.isOfferStatus($("#state_id").val())){var n=$("#ref_number").val().length;if(0<n&&n<4&&!confirm(MLInvoice.translate("InvoiceRefNumberTooShort")))return!1;if(void 0!==e.data("checkInvoiceNumber")){var i=String($("#invoice_no").val());if((""===i||"0"===i)&&!confirm(MLInvoice.translate("InvoiceNumberNotDefined")))return!1}}return!0}function T(){var e=$("#attachments-form").data("invoiceId"),d=$("<div/>");l=0,$.getJSON("json.php?func=get_invoice_attachments&parent_id="+e,function(e){var c=0;$.each(e.records,function(e,t){c+=1,t.order_no>l&&(l=t.order_no);var a=$("<div/>").addClass("attachment");$("<a/>").addClass("tinyactionlink ui-button ui-corner-all ui-widget remove-attachment").text(" X ").attr("title",MLInvoice.translate("RemoveAttachment")).click(function(){$.getJSON("json.php?func=delete_invoice_attachment&id="+t.id,function(){T()})}).appendTo(a);var n=$("<input>").attr("type","checkbox").data("id",t.id).prop("checked",t.send);n.change(function(){$.ajax({url:"json.php?func=put_invoice_attachment",data:{id:$(this).data("id"),send:$(this).prop("checked")?"1":"0"},type:"POST",dataType:"json"})});var i=$("<label/>").addClass("attachment-send");n.appendTo(i),$("<span/>").text(MLInvoice.translate("SendToClient")).appendTo(i),i.appendTo(a);var o=$("<input/>").addClass("attachment-name").attr("type","text").data("id",t.id).val(t.name).attr("placeholder",MLInvoice.translate("Description"));o.change(function(){$.ajax({url:"json.php?func=put_invoice_attachment",data:{id:$(this).data("id"),name:$(this).val()},type:"POST",dataType:"json"})}),o.appendTo(a);var r=$("<div/>").addClass("attachment-fileinfo");$("<a/>").attr("href","attachment.php?type=invoice&id="+t.id).attr("target","_blank").text(t.filename).appendTo(r);var s=$("<span/>").text(" ("+t.filesize_readable+")");1048576<t.filesize&&(s.addClass("large-file"),s.attr("title",MLInvoice.translate("LargeFile"))),s.appendTo(r),r.appendTo(a),a.appendTo(d)}),0===c&&d.text(MLInvoice.translate("NoEntries")),$(".attachment-list").empty().append(d),$(".attachment-count").text(c)})}function S(){"invoice"===u.type&&!u.modificationWarningShown&&u.modificationWarning&&(alert(u.modificationWarning),u.modificationWarningShown=!0)}function I(){b();var e=String($("#base_id").val());""!==e&&$.ajax({url:"json.php?func=get_base",data:{id:e},type:"GET",success:function(i){var e=$("#state_id").val();$.ajax({url:"json.php?func=get_invoice_state",data:{id:e},type:"GET",success:function(e){if(0!=e.invoice_open){var t=1==e.invoice_offer?"offer":"invoice";if(i[t+"_default_foreword"]){var a=$("#foreword").val();""!==a&&a!==i.invoice_default_foreword&&a!==i.offer_default_foreword||$("#foreword").val(i[t+"_default_foreword"])}if(i[t+"_default_afterword"]){var n=$("#afterword").val();""!==n&&n!==i.invoice_default_afterword&&n!==i.offer_default_afterword||$("#afterword").val(i[t+"_default_afterword"])}i.invoice_default_info&&""==$("#info").val()&&$("#info").val(i.invoice_default_info)}}})}})}return{initForm:function(e,t,a){var n;p=t,o=a,(u=e).modificationWarningShown=!1,$("#admin_form").find('input[type="text"]:not([name="payment_date"]),input[type="hidden"],input[type="checkbox"]:not([name="archived"]),select:not(.dropdownmenu),textarea').one("change",S),$(".save_button").click(function(){return MLInvoice.Form.saveRecord(),!1}),$("#base_id").change(I),$("#state_id").change(I),$("#company_id.select2").val()&&g(),$(".update-stock-balance").click(function(){return d(),!1}),$("#base_id.linked").change(f),f($("#base_id.linked")),$("#company_id.linked").change(v),v($("#company_id.linked")),i=$("a.ytj_search_button"),0!==i.length&&i.click(function(){var a=$("#company_id").val();if(a||(a=$("#company_name").val()),""!==(a=window.prompt(MLInvoice.translate("SearchYTJPrompt"),a))&&null!==a){var e=a.replace(/FI-?/i,"");$.ajax({url:"https://avoindata.prh.fi/bis/v1",data:{maxResults:1,businessId:e},global:!1}).done(function(e){void 0!==e.results[0]&&m(e.results[0])}).fail(function(e,t){404===e.status?$.ajax({url:"https://avoindata.prh.fi/bis/v1",data:{maxResults:1,name:a},global:!1}).done(function(e){void 0!==e.results[0]&&m(e.results[0])}).fail(function(e,t){404===e.status?window.alert(MLInvoice.translate("NoYTJResultsFound")):window.alert("Request failed: "+e.status+" - "+t)}):window.alert("Request failed: "+e.status+" - "+t)})}}),c(),_(),h(),n=$("#attachments-form").data("invoiceId"),$("#attachments-button").click(function(){$("#attachments-form").hasClass("hidden")&&T(),$("#attachments-button .dropdown-open").toggleClass("hidden"),$("#attachments-button .dropdown-close").toggleClass("hidden"),$("#attachments-form").toggleClass("hidden")}),$("a.add-attachment").click(function(){$.ajax({url:"json.php?func=add_invoice_attachment&id="+$(this).data("id")+"&invoice_id="+n,type:"POST",dataType:"json",success:function(){T()}})}),$("#new-attachment-file").change(function(){if(0<this.files.length){var e=new FormData;e.append("filedata",this.files[0]),e.append("invoice_id",n),e.append("order_no",l+5),$.ajax({url:"json.php?func=put_invoice_attachment",type:"POST",dataType:"json",data:e,processData:!1,contentType:!1,success:function(e){e.warnings&&alert(e.warnings),e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):T()}}),$(this).val(null)}}),b();var i},initAddressAutocomplete:function(a){var t=document.getElementById(a+"street_address");if(null!==t){$(t).attr("placeholder",""),$(t).blur(function(){var e=$(t).val();setTimeout(function(){$(t).val(e)},0)});var n=new google.maps.places.Autocomplete(t,{types:["geocode"]});google.maps.event.addListener(n,"place_changed",function(){var e=n.getPlace();setTimeout(function(){$("#"+a+"street_address").val(e.name),$.each(e.address_components,function(e,t){0<=$.inArray("postal_code",t.types)?$("#"+a+"zip_code").val(t.long_name).trigger("change"):0<=$.inArray("locality",t.types)||0<=$.inArray("administrative_area_level_3",t.types)?$("#"+a+"city").val(t.long_name).trigger("change"):0<=$.inArray("country",t.types)&&$("#"+a+"country").val(t.long_name).trigger("change")})},0)})}},saveRecord:function(a,n,i){MLInvoice.clearMessages();var o=$("#admin_form"),r=new FormData;$.each(u.fields,function(e,t){var a=o.find("[name="+t.name+"]");switch(t.type){case"CHECK":r.append(t.name,a.prop("checked"));break;case"INT":r.append(t.name,a.val().replace(MLInvoice.translate("DecimalSeparator"),"."));break;case"FILE":0<a.get(0).files.length&&r.append(t.name,a.get(0).files[0]);break;case"SELECT":case"SEARCHLIST":case"INTDATE":case"LIST":case"TEXT":case"PASSWD":case"TAGS":r.append(t.name,a.val());break;case"AREA":if(a.hasClass("markdown")){var n=a.data("mde");r.append(t.name,void 0!==n?n.value():a.val())}else r.append(t.name,a.val())}}),r.append("id",o.find("#record_id").val()),void 0!==i&&r.append("onPrint",i),$.ajax({url:"json.php?func=put_"+u.type,type:"POST",dataType:"json",data:r,processData:!1,contentType:!1,success:function(e){if(e.warnings&&alert(e.warnings),e.missing_fields)MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields);else if("invoice"===u.type&&void 0!==i&&i&&($("input#invoice_no").val(e.invoice_no),$("input#ref_number").val(e.ref_number)),$(".save_button").removeClass("ui-state-highlight"),MLInvoice.infomsg(MLInvoice.translate("RecordSaved"),2e3),a&&("openwindow"===n?window.open(a):window.location=a),!o.find("#record_id").val()&&(o.find("#record_id").val(e.id),!a||"openwindow"===n)){var t=new String(window.location).split("#",1)[0];window.location=t+"&id="+e.id}}})},initRows:function(i){$(".cb-select-all").prop("checked",!1);var e="";switch(p.type){case"company":e="get_companies";break;case"company_contact":e="get_company_contacts";break;case"invoice_row":e="get_invoice_rows";break;case"send_api_config":e="get_send_api_configs"}var s=u.readOnly,c=u.type,d=u.id,_=p,h=o,l=this;$.getJSON("json.php?func="+e+"&parent_id="+u.id,function(e){var r=$("#itable");if($("#itable > tbody > tr[id!=form_row]").remove(),$.each(e.records,function(e,v){var m=$("<tr/>").addClass("item-row");if(!s&&"invoice"===c){$('<td class="sort-col"><span class="sort-handle hidden"><i class="fa fa-sort"></i><span class="sr-only">'+MLInvoice.translate("Sort")+"</span></span>").appendTo(m);var t=MLInvoice.translate("SelectRow"),a=$("<input/>").addClass("cb-select-row").attr("type","checkbox").attr("title",t).attr("aria-label",t).click(function(){MLInvoice.updateRowSelectedState($(this).closest(".list_container"))});a.val(v.id);var n=$('<td class="select-row"/>');n.append(a),m.append(n)}if($.each(_.fields,function(e,t){var a=$("<td/>").addClass(t.style+(v.deleted?" deleted":""));a.data("field",t.name);var n=v[t.name];switch(t.type){case"LIST":case"SEARCHLIST":var i=t.name+"_text",o="";if(o=void 0!==v[i]&&null!==v[i]||void 0===h[t.name][n]?v[i]:h[t.name][n],"invoice_row"===_.type&&"product_id"===t.name){if(null!==n){var r=$("<a/>").attr("href","?func=settings&list=product&form=product&listid=list_product&id="+v[t.name]).text(o);a.append(r)}}else a.text(o);a.appendTo(m);break;case"PASSWD_STORED":a.text(""),a.appendTo(m);break;case"INT":void 0!==t.decimals?a.text(n?MLInvoice.formatCurrency(n,t.decimals):""):a.text(n?String(n).replace(".",MLInvoice.translate("DecimalSeparator")):""),a.appendTo(m);break;case"INTDATE":a.text(null!==n?MLInvoice.formatDate(n):""),a.appendTo(m);break;case"CHECK":a.text(MLInvoice.translate(n?"YesButton":"NoButton")),a.appendTo(m);break;case"ROWSUM":var s=MLInvoice.calcRowSum(v),c=MLInvoice.formatCurrency(s.sum),d=MLInvoice.formatCurrency(s.VAT),l=MLInvoice.formatCurrency(s.sumVAT),u=MLInvoice.translate("VATLess")+": "+c+" &ndash; "+MLInvoice.translate("VATPart")+": "+d,p=$("<span/>").attr("title",u).text(l);a.append(p),a.appendTo(m);break;case"TAGS":var f=n?String(n):"";f=f.replace(new RegExp(/,/,"g"),", "),a.text(f),a.appendTo(m);break;case"TEXT":case"AREA":a.text(n||""),a.appendTo(m)}}),!s){var i=$("<a/>").addClass("tinyactionlink ui-button ui-corner-all ui-widget row-edit-button").attr("href","#").text(MLInvoice.translate("Edit")).click(function(e){return l.popupEditor(e,MLInvoice.translate("RowModification"),v.id,!1),!1});if($("<td/>").addClass("button").append(i).appendTo(m),"invoice_row"!==_.type||!v.reminder_row){var o=$("<a/>").addClass("tinyactionlink ui-button ui-corner-all ui-widget row-copy-button").attr("href","#").data("id",d).text(MLInvoice.translate("Copy")).click(function(e){return l.popupEditor(e,MLInvoice.translate("RowCopy"),v.id,!0),!1});$("<td/>").addClass("button").append(o).appendTo(m)}}r.append(m)}),"invoice_row"===_.type){var t=function(e){for(var t=0,a=0,n=0,i=0,o=0,r=0;r<e.length;r++){var s=e[r];if(s.partial_payment)o+=parseFloat(s.price);else{var c=s.pcs,d=s.price,l=s.discount||0,u=s.discount_amount||0,p=s.vat,f=s.vat_included;null!==s.product_weight&&(i+=c*parseFloat(s.product_weight)),d*=1-l/100,d-=u;var v=0,m=0,_=0;1==f?_=(m=c*d)-(v=m/(1+p/100)):m=(v=c*d)+(_=v*(p/100)),t+=v,a+=_,n+=m}}return{totSum:t,totVAT:a,totSumVAT:n,totWeight:i,partialPayments:o}}(e.records),a=$("<tr/>").addClass("summary"),n=$("<td/>").addClass("input").attr("colspan","6").attr("rowspan","2");s||(n.text(MLInvoice.translate("ForSelected")+": "),$("<button/>").attr("id","delete-selected-rows").addClass("selected-row-button ui-button ui-corner-all ui-widget").text(MLInvoice.translate("Delete")).click(function(){return l.deleteSelectedRows(),!1}).appendTo(n),n.append($("<span/>").text(" ")),$("<button/>").attr("id","update-selected-rows").addClass("selected-row-button ui-button ui-corner-all ui-widget").text(MLInvoice.translate("Modify")).click(function(e){return l.multiEditor(e,MLInvoice.translate("ModifySelectedRows")),!1}).appendTo(n)),n.appendTo(a),$("<td/>").addClass("input").attr("colspan","6").attr("align","right").text(MLInvoice.translate("TotalExcludingVAT")).appendTo(a),$("<td/>").addClass("input currency").attr("align","right").text(MLInvoice.formatCurrency(t.totSum)).appendTo(a),$("<td/>").attr("colspan","2").appendTo(a),r.append(a),a=$("<tr/>").addClass("summary"),$("<td/>").addClass("input").attr("colspan","6").attr("align","right").text(MLInvoice.translate("TotalVAT")).appendTo(a),$("<td/>").addClass("input currency").attr("align","right").text(MLInvoice.formatCurrency(t.totVAT)).appendTo(a),$("<td/>").attr("colspan","2").appendTo(a),r.append(a),a=$("<tr/>").addClass("summary"),$("<td/>").addClass("input").attr("colspan","12").attr("align","right").text(MLInvoice.translate("TotalIncludingVAT")).appendTo(a),$("<td/>").addClass("input currency").attr("align","right").text(MLInvoice.formatCurrency(t.totSumVAT)).appendTo(a),$("<td/>").attr("colspan","2").appendTo(a),r.append(a),a=$("<tr/>").addClass("summary"),$("<td/>").addClass("input").attr("colspan","12").attr("align","right").text(MLInvoice.translate("TotalToPay")).appendTo(a),$("<td/>").addClass("input currency").attr("align","right").text(MLInvoice.formatCurrency(t.totSumVAT+t.partialPayments)).appendTo(a),$("<td/>").attr("colspan","2").appendTo(a),r.append(a),0<t.totWeight&&(a=$("<tr/>").addClass("summary"),$("<td/>").addClass("input").attr("colspan","12").attr("align","right").text(MLInvoice.translate("ProductWeight")).appendTo(a),$("<td/>").addClass("input currency").attr("align","right").text(MLInvoice.formatCurrency(t.totWeight,3)).appendTo(a),$("<td/>").attr("colspan","2").appendTo(a),r.append(a))}MLInvoice.updateRowSelectedState(),$("#itable tr").mouseover(function(){$(this).find(".sort-handle").removeClass("hidden")}).mouseout(function(){$(this).find(".sort-handle").addClass("hidden")}),s||"invoice"!==c||$("#itable > tbody").sortable({axis:"y",handle:".sort-col",items:"tr.item-row",stop:function(){l.updateRowOrder()}}),$("#iform").find('input[type="text"],input[type="hidden"],input[type="checkbox"]:not(.cb-select-row):not(.cb-select-all),select:not(.dropdownmenu),textarea').change(function(){$(".row-add-button").addClass("ui-state-highlight")}),$("#iform").find('input[type="text"],input[type="hidden"],input[type="checkbox"],select:not(.dropdownmenu),textarea').one("change",S),$("#iform_popup").find('input[type="text"],input[type="hidden"]:not(.select-default-text),input[type="checkbox"],select:not(.dropdownmenu),textarea').change(function(){$(this).parent().find(".modification-indicator").removeClass("hidden"),$(this).data("modified",1)}),void 0!==i&&i(),_.dispatchByDateButtons&&l.updateDispatchByDateButtons(e.records)})},updateRowOrder:function(){var e={};e.table=p.type,e.order={};var t=1;$(".cb-select-row").each(function(){e.order[this.value]=t,t+=1}),$.ajax({url:"json.php?func=update_row_order",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(){MLInvoice.Form.initRows()}})},saveRow:function(o){MLInvoice.clearMessages();var r=$("#"+o),i={};$.each(p.fields,function(e,t){var a=r.find("[name="+o+"_"+t.name+"]");switch(t.type){case"CHECK":i[t.name]=a.prop("checked");break;case"INT":i[t.name]=a.val().replace(MLInvoice.translate("DecimalSeparator"),".");break;case"TAGS":case"SEARCHLIST":case"INTDATE":case"LIST":case"TEXT":case"PASSWD":case"PASSWD_STORED":i[t.name]=a.val();break;case"AREA":if(a.hasClass("markdown")){var n=a.data("mde");i[t.name]=void 0!==n?n.value():a.val()}else i[t.name]=a.val()}}),i[p.parentKey]=u.id;var e=r.data("rowId");e&&(i.id=e);var s=p,t=this;$.ajax({url:"json.php?func=put_"+p.type,type:"POST",dataType:"json",data:JSON.stringify(i),contentType:"application/json; charset=utf-8",success:function(e){e.error?MLInvoice.errormsg(e.error):e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(MLInvoice.infomsg(MLInvoice.translate("RecordSaved"),2e3),r.find(".row-add-button").removeClass("ui-state-highlight"),t.initRows(),r.data("popup")&&$("#popup_edit").dialog("close"),i.id||(""!==s.onAfterRowAdded&&s.onAfterRowAdded(),$.each(s.fields,function(e,t){var a=r.find("[name="+o+"_"+t.name+"]");if(void 0!==t.default&&String(t.default).startsWith("ADD+"))a.val(parseInt(a.val(),10)+parseInt(String(t.default).substr(4)));else if(void 0!==t.default&&"DATE_NOW"===t.default){var n=(new Date).toISOString().replace(/-/g,"").substr(0,8);a.val(MLInvoice.formatDate(n))}else if(s.clearAfterRowAdded)switch(t.type){case"LIST":a.val([]);break;case"SEARCHLIST":a.select2("val","");break;case"CHECK":a.prop("checked",!1);break;case"INT":case"INTDATE":case"TEXT":a.val("");break;case"AREA":if(a.hasClass("markdown")){var i=a.data("mde");void 0!==i?i.value(""):a.val("")}else a.val("")}})))}})},deleteRow:function(e){var t=$("#"+e).data("rowId");$.ajax({url:"json.php?func=delete_"+p.type+"&id="+t,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:function(){MLInvoice.Form.initRows(),"iform_popup"==e&&$("#popup_edit").dialog("close")}})},deleteSelectedRows:function(){var e={};e.id=$(".cb-select-row:checked").map(function(){return this.value}).get(),$.ajax({url:"json.php?func=delete_"+p.type,type:"POST",dataType:"json",data:e,success:function(){MLInvoice.Form.initRows()}})},popupEditor:function(e,t,a,c){S(),$("#iform_popup .modification-indicator").addClass("hidden"),$("#iform_popup input").data("modified","");var n=p,i=this;$.getJSON("json.php?func=get_"+p.type+"&id="+a,function(r){if(r.id){var s=$("#iform_popup");c?s.data("rowId",""):s.data("rowId",a),$.each(n.fields,function(e,t){var a=s.find("[name=iform_popup_"+t.name+"]");switch(t.type){case"CHECK":a.prop("checked",r[t.name]?1:0);break;case"INT":c&&t.default&&-1!==t.default.indexOf("ADD")?a.val(parseInt(r[t.name],10)+5):void 0!==t.decimals?a.val(r[t.name]?MLInvoice.formatCurrency(r[t.name],t.decimals):""):a.val(r[t.name]?String(r[t.name]).replace(".",MLInvoice.translate("DecimalSeparator")):"");break;case"SEARCHLIST":var n={id:r[t.name],text:r[t.name+"_text"]};a.select2("data",n);break;case"INTDATE":a.val(r[t.name]?MLInvoice.formatDate(r[t.name]):"");break;case"PASSWD_STORED":a.val("");break;case"TAGS":var i=[];$(r[t.name].split(",")).each(function(){i.push({id:this,text:this})}),a.select2("data",i);break;case"LIST":case"TEXT":a.val(r[t.name]);break;case"AREA":if(a.hasClass("markdown")){var o=a.data("mde");void 0!==o?o.value(r[t.name]):a.val(r[t.name])}else a.val(r[t.name])}}),h($("#popup_edit"));var e={};e[MLInvoice.translate("Save")]=function(){i.saveRow("iform_popup")},c||(e[MLInvoice.translate("Delete")]=function(){return!0===confirm(MLInvoice.translate("ConfirmDelete"))&&i.deleteRow("iform_popup"),!1}),e[MLInvoice.translate("Close")]=function(){$("#popup_edit").dialog("close")},$("#popup_edit").dialog({modal:!0,width:n.popupWidth,height:180,resizable:!0,buttons:e,title:t})}})},multiEditor:function(e,t){S(),$("#iform_popup .modification-indicator").addClass("hidden"),$("#iform_popup input").data("modified",0),$("#iform_popup select").data("modified",0);var i=$("#iform_popup");$.each(p.fields,function(e,t){var a=i.find("[name=iform_popup_"+t.name+"]");switch(t.type){case"CHECK":a.prop("checked",!1);break;case"SEARCHLIST":a.select2("data",{});break;case"TAGS":a.select2("data",[]);break;case"PASSWD_STORED":case"INT":case"INTDATE":case"LIST":case"TEXT":a.val("");break;case"AREA":if(a.hasClass("markdown")){var n=a.data("mde");void 0!==n?n.value(""):a.val("")}else a.val("")}}),i.find(".modification-indicator").addClass("hidden"),h($("#popup_edit"));var a={},n=this;a[MLInvoice.translate("Save")]=function(){n.modifyRows("iform_popup")},a[MLInvoice.translate("Close")]=function(){$("#popup_edit").dialog("close")},$("#popup_edit").dialog({modal:!0,width:p.popupWidth,height:180,resizable:!0,buttons:a,title:t})},modifyRows:function(i){MLInvoice.clearMessages();var o=$("#"+i),r={};$.each(p.fields,function(e,t){var a=o.find("[name="+i+"_"+t.name+"]");if(a.data("modified"))switch(t.type){case"CHECK":r[t.name]=a.prop("checked");break;case"INT":r[t.name]=a.val().replace(MLInvoice.translate("DecimalSeparator"),".");break;case"SEARCHLIST":r[t.name]=a.select2("data");break;case"LIST":case"INTDATE":case"TEXT":r[t.name]=a.val();break;case"AREA":if(a.hasClass("markdown")){var n=a.data("mde");r[t.name]=void 0!==n?n.value():a.val()}else r[t.name]=a.val()}});var e={};e.table=p.type,e.ids=$("#iform .cb-select-row:checked").map(function(){return this.value}).get(),e.changes=r,$.ajax({url:"json.php?func=update_multiple",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):($("#popup_edit").dialog("close"),MLInvoice.Form.initRows())}})},addCompany:function(t){var e={};e[t.save]=function(){var a,e;a=t,(e={}).company_name=document.getElementById("quick_name").value,e.email=document.getElementById("quick_email").value,e.phone=document.getElementById("quick_phone").value,e.street_address=document.getElementById("quick_street_address").value,e.zip_code=document.getElementById("quick_zip_code").value,e.city=document.getElementById("quick_city").value,e.country=document.getElementById("quick_country").value,$.ajax({url:"json.php?func=put_company",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){var t;e.missing_fields?alert(a.missing+e.missing_fields):(t=e.id,$.getJSON("json.php?func=get_company",{id:t},function(e){var t=e.company_name;e.company_id&&(t+=" ("+e.company_id+")");var a=$("#company_id");a.select2("data",{id:e.id,text:t}),a.trigger("change")}),$("#quick_add_company").dialog("close"))}})},e[t.close]=function(){$("#quick_add_company").dialog("close")},$("#quick_add_company").dialog({modal:!0,width:420,height:320,resizable:!1,zIndex:900,buttons:e,title:t.title})},addPartialPayment:function(){var e={};e[MLInvoice.translate("Save")]=function(){var e;(e={}).invoice_id=$("#record_id").val(),e.description=MLInvoice.translate("PartialPayment"),e.row_date=$("#add_partial_payment_date").val(),e.price=-parseFloat($("#add_partial_payment_amount").val().replace(MLInvoice.translate("DecimalSeparator"),".")),e.pcs=0,e.vat=0,e.vat_included=0,e.order_no=1e5,e.partial_payment=1,$.ajax({url:"json.php?func=put_invoice_row",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){e.missing_fields?alert(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(MLInvoice.Form.initRows(),$("#add_partial_payment").dialog("close"))}})},e[MLInvoice.translate("Close")]=function(){$("#add_partial_payment").dialog("close")},$("#add_partial_payment").dialog({modal:!0,width:420,height:160,resizable:!1,zIndex:900,buttons:e,title:MLInvoice.translate("PartialPayment")})},getSelectedProductDefaults:function(e){if(null!==r){document.getElementById(e+"_description").value=r.description,s=r.description;for(var t=document.getElementById(e+"_type_id"),a=0;a<t.options.length;a++){var n=t.options[a];if(n.value===r.type_id){n.selected=!0;break}}document.getElementById(e+"_price").value=r.unit_price.replace(".",","),document.getElementById(e+"_discount").value=r.discount.replace(".",","),document.getElementById(e+"_vat").value=r.vat_percent.replace(".",","),document.getElementById(e+"_vat_included").checked=1===r.vat_included}},updateStockBalance:d,updateStockBalanceLog:a,printInvoice:function(e,t,a,n){if(w()){var i="invoice.php?id="+$("#record_id").val()+"&template="+e+"&func="+t;return void 0!==n&&(i+="&date="+n),void 0===$("#admin_form").data("readOnly")?MLInvoice.Form.saveRecord(i,a,!0):"openwindow"===a?window.open(i):window.location.href=i,!1}},updateDispatchByDateButtons:function(e){if("none"!==MLInvoice.getDispatchNotePrintStyle()&&!MLInvoice.isOfferStatus($("#state_id").val())){var t=$("#dispatch_date_buttons");t.empty();var a=[];$.each(e,function(e,t){if(t.reminder_row||t.partial_payment)return!0;-1===a.indexOf(t.row_date)&&a.push(t.row_date)}),a.sort();var n=this,i=function(){n.printInvoice(2,"open_invoices",MLInvoice.getDispatchNotePrintStyle(),$(this).data("date"))};for(var o in a)if(a.hasOwnProperty(o)){var r=$('<a class="formbuttonlink ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only"/>'),s=a[o];r.data("date",s),r.click(i),$('<span class="ui-button-text"/>').text(MLInvoice.translate("SettingDispatchNotes")+" "+MLInvoice.formatDate(s)).appendTo(r),t.append(r),t.append(" ")}}},setupSelect2:h,setupDefaultTextSelection:_,setupMarkdownEditor:c}});
//# sourceMappingURL=mlinvoice.min.js.map